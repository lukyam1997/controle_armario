<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Controle de Armários</title>
    <style>
      :root {
        color-scheme: light dark;
        font-family: "Inter", "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        --bg: #f5f7fa;
        --bg-card: #ffffff;
        --bg-muted: #edf1f7;
        --text: #1a2138;
        --text-muted: #5f6b8a;
        --primary: #1971c2;
        --primary-soft: rgba(25, 113, 194, 0.12);
        --danger: #d64545;
        --success: #2f9e44;
        --border: rgba(26, 33, 56, 0.08);
        --radius-lg: 18px;
        --radius-sm: 10px;
        --shadow: 0 18px 45px -25px rgba(26, 33, 56, 0.45);
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #0b101f;
          --bg-card: #121a2f;
          --bg-muted: rgba(255, 255, 255, 0.04);
          --text: #f7faff;
          --text-muted: rgba(247, 250, 255, 0.7);
          --primary-soft: rgba(80, 160, 255, 0.14);
          --border: rgba(255, 255, 255, 0.08);
          --shadow: 0 25px 55px -30px rgba(4, 10, 25, 0.9);
        }
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        background: var(--bg);
        color: var(--text);
        display: flex;
        justify-content: center;
        padding: clamp(16px, 4vw, 32px);
      }

      .app {
        width: min(1200px, 100%);
        display: flex;
        flex-direction: column;
        gap: clamp(16px, 4vw, 28px);
      }

      .topbar {
        background: linear-gradient(135deg, rgba(25, 113, 194, 0.9), rgba(25, 113, 194, 0.75));
        border-radius: var(--radius-lg);
        padding: clamp(18px, 4vw, 28px);
        color: #fff;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        box-shadow: var(--shadow);
      }

      .brand {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .brand span:first-child {
        font-size: clamp(1.3rem, 2.6vw, 1.8rem);
        font-weight: 700;
        letter-spacing: -0.01em;
      }

      .brand span:last-child {
        font-size: clamp(0.9rem, 1.6vw, 1rem);
        opacity: 0.85;
      }

      .topbar__actions {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      button,
      select,
      input,
      textarea {
        font: inherit;
      }

      .btn {
        border: none;
        border-radius: 999px;
        padding: 10px 18px;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease;
        font-weight: 600;
      }

      .btn--primary {
        background: #fff;
        color: #0b3d74;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.1);
      }

      .btn--primary:disabled {
        opacity: 0.7;
        cursor: wait;
      }

      .btn--ghost {
        background: transparent;
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.4);
      }

      .btn:active {
        transform: scale(0.98);
      }

      main {
        display: grid;
        gap: clamp(16px, 4vw, 28px);
        grid-template-columns: repeat(12, 1fr);
      }

      .panel {
        background: var(--bg-card);
        border-radius: var(--radius-lg);
        padding: clamp(18px, 4vw, 28px);
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 18px;
        border: 1px solid var(--border);
      }

      .panel--form {
        grid-column: span 4;
      }

      .panel--data {
        grid-column: span 8;
      }

      @media (max-width: 980px) {
        main {
          grid-template-columns: repeat(1, minmax(0, 1fr));
        }

        .panel--form,
        .panel--data {
          grid-column: span 1;
        }
      }

      .panel h2 {
        margin: 0;
        font-size: 1.1rem;
        letter-spacing: -0.01em;
      }

      .form {
        display: grid;
        gap: 14px;
      }

      .form__row {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      label {
        font-weight: 600;
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      input,
      select,
      textarea {
        background: var(--bg-muted);
        border: 1px solid transparent;
        border-radius: var(--radius-sm);
        padding: 12px 14px;
        color: var(--text);
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: rgba(25, 113, 194, 0.45);
        box-shadow: 0 0 0 3px var(--primary-soft);
      }

      textarea {
        min-height: 90px;
        resize: vertical;
      }

      .summary {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
      }

      .filters {
        background: var(--bg-muted);
        border-radius: var(--radius-sm);
        padding: 16px;
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        border: 1px solid var(--border);
      }

      .filters__group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .filters select {
        background: var(--bg-card);
        border: 1px solid rgba(26, 33, 56, 0.12);
        border-radius: var(--radius-sm);
        padding: 10px 12px;
      }

      .summary__card {
        background: var(--bg-muted);
        border-radius: var(--radius-sm);
        padding: 14px 16px;
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .summary__card strong {
        font-size: 1.4rem;
        letter-spacing: -0.01em;
      }

      .summary__card span {
        color: var(--text-muted);
        font-size: 0.9rem;
      }

      .monitor {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .monitor__header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .monitor__stats {
        display: flex;
        flex-direction: column;
        text-align: right;
        color: var(--text-muted);
        font-size: 0.85rem;
        gap: 4px;
      }

      .monitor__stats strong {
        color: var(--text);
        font-size: 1.1rem;
      }

      .monitor__stats-note {
        font-size: 0.78rem;
      }

      .monitor-board {
        display: grid;
        gap: 18px;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }

      .monitor-column {
        background: var(--bg-muted);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        border-top: 4px solid transparent;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02);
        min-height: 160px;
      }

      .monitor-column__header {
        display: flex;
        align-items: baseline;
        justify-content: space-between;
        gap: 12px;
      }

      .monitor-column__title {
        font-weight: 700;
        font-size: 0.95rem;
      }

      .monitor-column__count {
        font-weight: 700;
        font-size: 0.85rem;
        color: var(--text-muted);
      }

      .monitor-column__list {
        display: grid;
        gap: 10px;
        flex: 1;
      }

      .monitor-column__empty {
        font-size: 0.85rem;
        color: var(--text-muted);
      }

      .monitor-item {
        background: var(--bg-card);
        border-radius: var(--radius-sm);
        border: 1px solid var(--border);
        border-left: 3px solid transparent;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .monitor-item__header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 8px;
      }

      .monitor-item__title {
        font-weight: 700;
        font-size: 1rem;
      }

      .monitor-item__badge {
        font-size: 0.75rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(25, 113, 194, 0.12);
        color: var(--primary);
        white-space: nowrap;
      }

      .monitor-item__body {
        display: grid;
        gap: 8px;
      }

      .monitor-item__row {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        font-size: 0.85rem;
      }

      .monitor-item__row--multiline {
        flex-direction: column;
        align-items: flex-start;
      }

      .monitor-item__label {
        color: var(--text-muted);
        font-weight: 600;
      }

      .monitor-item__value {
        text-align: right;
      }

      .monitor-item__row--multiline .monitor-item__value {
        text-align: left;
        width: 100%;
      }

      .monitor-item__meta {
        display: block;
        margin-top: 4px;
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .monitor-item__empty {
        color: var(--text-muted);
        font-style: italic;
      }

      .monitor-item__notes {
        font-size: 0.82rem;
        color: var(--text-muted);
        border-top: 1px dashed var(--border);
        padding-top: 8px;
      }

      .table-wrapper {
        border-radius: var(--radius-sm);
        overflow: hidden;
        border: 1px solid var(--border);
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.92rem;
      }

      thead {
        background: var(--bg-muted);
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.04em;
      }

      th,
      td {
        padding: 12px 14px;
        text-align: left;
        border-bottom: 1px solid var(--border);
        vertical-align: top;
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      tbody tr:hover {
        background: rgba(25, 113, 194, 0.07);
      }

      .table-meta {
        display: block;
        margin-top: 4px;
        font-size: 0.78rem;
        color: var(--text-muted);
      }

      .status {
        font-weight: 600;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 8px;
        border-radius: 999px;
        background: var(--bg-muted);
      }

      .status--ativo {
        color: var(--success);
        background: rgba(47, 158, 68, 0.12);
      }

      .status--finalizado {
        color: var(--danger);
        background: rgba(214, 69, 69, 0.12);
      }

      .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .btn--table {
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--bg-card);
        padding: 6px 12px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease;
      }

      .btn--table:hover {
        background: var(--bg-muted);
      }

      .empty {
        padding: 28px;
        text-align: center;
        color: var(--text-muted);
      }

      .footer {
        text-align: center;
        font-size: 0.85rem;
        color: var(--text-muted);
        padding-bottom: 12px;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="topbar">
        <div class="brand">
          <span>Controle de Armários - SUS</span>
          <span>Agilidade para equipes e acolhimento para pacientes e famílias.</span>
        </div>
        <div class="topbar__actions">
          <button class="btn btn--ghost" type="button" id="refreshButton">Atualizar painel</button>
        </div>
      </header>
      <main>
        <section class="panel panel--form">
          <div>
            <h2>Novo registro</h2>
            <p style="margin: 6px 0 0; color: var(--text-muted); font-size: 0.9rem;">
              Preencha com atenção para garantir o rastreio completo dos pertences.
            </p>
          </div>
          <form class="form" id="entryForm">
            <div class="form__row">
              <label for="field-armario">Número do armário *</label>
              <input id="field-armario" name="armario" type="text" required placeholder="Ex.: A-12" />
            </div>
            <div class="form__row">
              <label for="field-unidade">Unidade *</label>
              <input id="field-unidade" name="unidade" list="unitsList" required placeholder="Ex.: UTI Adulto" />
              <datalist id="unitsList"></datalist>
            </div>
            <div class="form__row">
              <label for="field-perfil">Perfil *</label>
              <select id="field-perfil" name="perfil" required>
                <option value="">Selecione</option>
                <option value="Visitante">Visitante</option>
                <option value="Acompanhante">Acompanhante</option>
                <option value="Equipe">Equipe</option>
              </select>
            </div>
            <div class="form__row">
              <label for="field-responsavel">Responsável *</label>
              <input id="field-responsavel" name="responsavel" type="text" required placeholder="Nome completo" />
            </div>
            <div class="form__row">
              <label for="field-paciente">Paciente associado</label>
              <input id="field-paciente" name="paciente" type="text" placeholder="Nome do paciente" />
            </div>
            <div class="form__row">
              <label for="field-contato">Contato</label>
              <input id="field-contato" name="contato" type="text" placeholder="Telefone ou identificação" />
            </div>
            <div class="form__row">
              <label for="field-itens">Itens guardados</label>
              <textarea id="field-itens" name="itens" placeholder="Descreva os pertences guardados"></textarea>
            </div>
            <div class="form__row">
              <label for="field-observacoes">Observações</label>
              <textarea id="field-observacoes" name="observacoes" placeholder="Informações adicionais importantes"></textarea>
            </div>
            <button class="btn btn--primary" type="submit" id="submitButton">Registrar guarda</button>
          </form>
        </section>
        <section class="panel panel--data">
          <div>
            <h2>Painel de monitoramento</h2>
            <p style="margin: 6px 0 0; color: var(--text-muted); font-size: 0.9rem;">
              Acompanhe rapidamente quem está utilizando os armários e a situação de cada registro.
            </p>
          </div>
          <div class="filters" id="globalFilters">
            <div class="filters__group">
              <label for="filter-unit">Filtrar por unidade</label>
              <select id="filter-unit">
                <option value="">Todas as unidades</option>
              </select>
            </div>
            <div class="filters__group">
              <label for="filter-profile">Refinar por perfil</label>
              <select id="filter-profile" disabled>
                <option value="">Todos os perfis</option>
              </select>
            </div>
          </div>
          <div class="summary" id="summaryCards"></div>
          <div class="monitor">
            <div class="monitor__header">
              <div>
                <h3 style="margin: 0;">Monitor geral de armários</h3>
                <p style="margin: 4px 0 0; color: var(--text-muted); font-size: 0.85rem;">
                  Visualize a ocupação em tempo real de cada armário cadastrado.
                </p>
              </div>
              <div class="monitor__stats" id="monitorStats"></div>
            </div>
            <div class="monitor-board" id="monitorBoard"></div>
            <div class="empty" id="monitorEmpty" hidden>
              Nenhum armário encontrado para os filtros aplicados. Cadastre novos armários ou ajuste a seleção.
            </div>
          </div>
          <div class="table-wrapper">
            <table>
              <thead>
                <tr>
                  <th>Armário</th>
                  <th>Unidade</th>
                  <th>Perfil</th>
                  <th>Responsável</th>
                  <th>Paciente</th>
                  <th>Itens</th>
                  <th>Status</th>
                  <th>Registrado</th>
                  <th>Encerrado</th>
                  <th>Observações</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="entriesBody"></tbody>
            </table>
            <div class="empty" id="emptyState" hidden>
              Nenhum registro encontrado. Utilize o formulário ao lado para iniciar um novo controle.
            </div>
          </div>
        </section>
      </main>
      <footer class="footer">
        Desenvolvido para garantir acolhimento e segurança aos usuários do SUS. Simplifique, registre e acompanhe em minutos.
      </footer>
    </div>
    <script>
      const state = {
        entries: [],
        summary: null,
        lockers: [],
        filters: {
          unidade: '',
          perfil: '',
        },
      };

      const form = document.getElementById('entryForm');
      const submitButton = document.getElementById('submitButton');
      const refreshButton = document.getElementById('refreshButton');
      const summaryContainer = document.getElementById('summaryCards');
      const tableBody = document.getElementById('entriesBody');
      const emptyState = document.getElementById('emptyState');
      const unitsList = document.getElementById('unitsList');
      const unitFilter = document.getElementById('filter-unit');
      const profileFilter = document.getElementById('filter-profile');
      const monitorBoard = document.getElementById('monitorBoard');
      const monitorEmpty = document.getElementById('monitorEmpty');
      const monitorStats = document.getElementById('monitorStats');
      const defaultEmptyMessage = emptyState.textContent;
      const monitorEmptyDefault = monitorEmpty.textContent;

      function setLoading(isLoading) {
        if (isLoading) {
          submitButton.disabled = true;
          submitButton.textContent = 'Salvando...';
        } else {
          submitButton.disabled = false;
          submitButton.textContent = 'Registrar guarda';
        }
      }

      function fetchData() {
        summaryContainer.innerHTML = '';
        tableBody.innerHTML = '';
        monitorBoard.innerHTML = '';
        monitorStats.textContent = '';
        monitorEmpty.textContent = monitorEmptyDefault;
        monitorEmpty.hidden = true;
        emptyState.textContent = defaultEmptyMessage;
        emptyState.hidden = true;
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          emptyState.hidden = false;
          emptyState.textContent = 'Interface em modo demonstrativo. Publique o app para carregar os dados.';
          monitorEmpty.hidden = false;
          monitorEmpty.textContent = 'Interface em modo demonstrativo. Publique o app para visualizar o monitor.';
          return;
        }
        google.script.run
          .withSuccessHandler((result) => {
            const previousFilters = { ...state.filters };
            state.entries = result.entries || [];
            state.summary = result.summary || null;
            state.lockers = result.lockers || [];
            restoreFilters(previousFilters);
            renderSummary();
            renderFilters();
            renderTable();
            renderMonitor();
            renderUnitsList();
          })
          .withFailureHandler((err) => {
            console.error(err);
            emptyState.hidden = false;
            emptyState.textContent = 'Não foi possível carregar os dados. Tente novamente em instantes.';
            monitorEmpty.hidden = false;
            monitorEmpty.textContent = 'Não foi possível carregar o monitor. Tente novamente em instantes.';
          })
          .getDashboardData();
      }

      function restoreFilters(previous) {
        const unidadesDisponiveis = new Set((state.summary && state.summary.unidades) || []);
        if (previous && previous.unidade && unidadesDisponiveis.has(previous.unidade)) {
          state.filters.unidade = previous.unidade;
        } else {
          state.filters.unidade = '';
        }
        const perfisDisponiveis = new Set(getProfilesForUnit(state.filters.unidade));
        if (previous && previous.perfil && perfisDisponiveis.has(previous.perfil)) {
          state.filters.perfil = previous.perfil;
        } else {
          state.filters.perfil = '';
        }
      }

      function renderSummary() {
        summaryContainer.innerHTML = '';
        const summary = state.summary;
        if (!summary) {
          return;
        }
        const cards = [
          { label: 'Armários ocupados', value: summary.ocupados || 0, accent: 'var(--danger)' },
          { label: 'Armários livres', value: summary.disponiveis || 0, accent: 'var(--success)' },
          { label: 'Taxa de ocupação', value: `${summary.ocupacaoPercentual || 0}%`, accent: 'var(--primary)' },
          { label: 'Registros ativos', value: summary.ativos || 0, accent: 'var(--success)' },
          { label: 'Registros finalizados', value: summary.finalizados || 0, accent: 'var(--danger)' },
          { label: 'Total cadastrado', value: summary.total || 0, accent: 'var(--primary)' },
        ];
        cards.forEach((card) => {
          const element = document.createElement('div');
          element.className = 'summary__card';
          element.innerHTML = `<span>${card.label}</span><strong style="color: ${card.accent}">${card.value}</strong>`;
          summaryContainer.appendChild(element);
        });

        if (summary.porPerfil) {
          Object.entries(summary.porPerfil)
            .sort((a, b) => a[0].localeCompare(b[0], 'pt-BR'))
            .forEach(([perfil, count]) => {
              const element = document.createElement('div');
              element.className = 'summary__card';
              element.innerHTML = `<span>Perfil: ${perfil}</span><strong>${count}</strong>`;
              summaryContainer.appendChild(element);
            });
        }
      }

      function renderFilters() {
        const summary = state.summary;
        if (!summary) {
          unitFilter.innerHTML = '<option value="">Todas as unidades</option>';
          unitFilter.value = '';
          profileFilter.innerHTML = '<option value="">Todos os perfis</option>';
          profileFilter.value = '';
          profileFilter.disabled = true;
          return;
        }
        const unidades = summary.unidades || [];
        const unidadeOptions = ['<option value="">Todas as unidades</option>'];
        unidades.forEach((unidade) => {
          const value = escapeHtml(unidade);
          unidadeOptions.push(`<option value="${value}">${value}</option>`);
        });
        unitFilter.innerHTML = unidadeOptions.join('');
        unitFilter.value = state.filters.unidade;

        const perfis = getProfilesForUnit(state.filters.unidade);
        const perfilOptions = ['<option value="">Todos os perfis</option>'];
        perfis.forEach((perfil) => {
          const value = escapeHtml(perfil);
          perfilOptions.push(`<option value="${value}">${value}</option>`);
        });
        profileFilter.innerHTML = perfilOptions.join('');
        const hasUnit = Boolean(state.filters.unidade);
        profileFilter.disabled = !hasUnit;
        if (hasUnit && state.filters.perfil) {
          profileFilter.value = state.filters.perfil;
        } else {
          profileFilter.value = '';
          if (!hasUnit) {
            state.filters.perfil = '';
          }
        }
      }

      function getProfilesForUnit(unidade) {
        const profiles = new Set();
        const compare = unidade ? unidade : null;
        state.entries.forEach((entry) => {
          if (compare && entry.unidade !== compare) return;
          if (entry.perfil) {
            profiles.add(entry.perfil);
          }
        });
        state.lockers.forEach((locker) => {
          if (compare && locker.unidade !== compare) return;
          if (locker.registro && locker.registro.perfil) {
            profiles.add(locker.registro.perfil);
          }
        });
        return Array.from(profiles).sort((a, b) => a.localeCompare(b, 'pt-BR'));
      }

      function getFilteredEntries() {
        return state.entries.filter((entry) => {
          if (state.filters.unidade && entry.unidade !== state.filters.unidade) {
            return false;
          }
          if (state.filters.perfil && entry.perfil !== state.filters.perfil) {
            return false;
          }
          return true;
        });
      }

      function getFilteredLockers() {
        return state.lockers.filter((locker) => {
          if (state.filters.unidade && locker.unidade !== state.filters.unidade) {
            return false;
          }
          if (state.filters.perfil) {
            return locker.registro && locker.registro.perfil === state.filters.perfil;
          }
          return true;
        });
      }

      function renderUnitsList() {
        unitsList.innerHTML = '';
        const summary = state.summary;
        if (!summary || !summary.unidades) return;
        summary.unidades.forEach((unit) => {
          const option = document.createElement('option');
          option.value = unit;
          unitsList.appendChild(option);
        });
      }

      function renderTable() {
        tableBody.innerHTML = '';
        const entries = getFilteredEntries();
        if (!state.entries.length) {
          emptyState.hidden = false;
          emptyState.textContent = defaultEmptyMessage;
          return;
        }
        if (!entries.length) {
          emptyState.hidden = false;
          emptyState.textContent = 'Nenhum registro corresponde aos filtros aplicados.';
          return;
        }
        emptyState.hidden = true;
        entries.forEach((entry) => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${formatCell(entry.armario)}</td>
            <td>${formatCell(entry.unidade)}</td>
            <td>${formatCell(entry.perfil)}</td>
            <td>${formatCell(entry.responsavel)}${renderContact(entry.contato)}</td>
            <td>${formatCell(entry.paciente)}</td>
            <td>${formatCell(entry.itens)}</td>
            <td>${renderStatus(entry.status)}</td>
            <td>${formatCell(entry.criadoEm)}</td>
            <td>${formatCell(entry.encerradoEm)}</td>
            <td>${formatMultiline(entry.observacoes)}</td>
            <td>${renderActions(entry)}</td>
          `;
          tableBody.appendChild(row);
        });
      }

      function renderMonitor() {
        monitorBoard.innerHTML = '';
        const lockers = getFilteredLockers();
        if (!state.lockers.length) {
          monitorEmpty.hidden = false;
          monitorEmpty.textContent = monitorEmptyDefault;
          monitorStats.textContent = '';
          return;
        }
        if (!lockers.length) {
          monitorEmpty.hidden = false;
          monitorEmpty.textContent = 'Nenhum armário encontrado para os filtros aplicados. Cadastre novos armários ou ajuste a seleção.';
          monitorStats.textContent = '';
          return;
        }
        monitorEmpty.hidden = true;

        const groups = new Map();
        lockers.forEach((locker) => {
          const meta = getStatusMeta(locker.status);
          if (!groups.has(meta.key)) {
            groups.set(meta.key, { meta, items: [] });
          }
          groups.get(meta.key).items.push(locker);
        });

        // garante que os status principais sempre apareçam
        ['ocupado', 'livre'].forEach((key) => {
          const meta = getStatusMeta(key);
          if (!groups.has(meta.key)) {
            groups.set(meta.key, { meta, items: [] });
          }
        });

        const sortedGroups = Array.from(groups.values()).sort((a, b) => {
          if (a.meta.order !== b.meta.order) {
            return a.meta.order - b.meta.order;
          }
          return a.meta.columnTitle.localeCompare(b.meta.columnTitle, 'pt-BR');
        });

        sortedGroups.forEach((group) => {
          const column = document.createElement('section');
          column.className = 'monitor-column';
          column.style.borderTopColor = group.meta.accent;

          const header = document.createElement('div');
          header.className = 'monitor-column__header';
          header.innerHTML = `
            <span class="monitor-column__title">${escapeHtml(group.meta.columnTitle)}</span>
            <span class="monitor-column__count">${group.items.length}</span>
          `;
          column.appendChild(header);

          const list = document.createElement('div');
          list.className = 'monitor-column__list';

          if (!group.items.length) {
            const emptyMessage = document.createElement('p');
            emptyMessage.className = 'monitor-column__empty';
            emptyMessage.textContent = group.meta.emptyMessage;
            list.appendChild(emptyMessage);
          } else {
            group.items.forEach((locker) => {
              list.appendChild(createMonitorItem(locker, group.meta));
            });
          }

          column.appendChild(list);
          monitorBoard.appendChild(column);
        });

        const total = lockers.length;
        const ocupados = groups.get('ocupado') ? groups.get('ocupado').items.length : 0;
        const livres = groups.get('livre') ? groups.get('livre').items.length : 0;
        const percentual = total ? Math.round((ocupados / total) * 1000) / 10 : 0;
        monitorStats.innerHTML = `<strong>${total}</strong> armários • <strong>${ocupados}</strong> em uso • <strong>${livres}</strong> disponíveis<div class="monitor__stats-note">Ocupação ${isFinite(percentual) ? percentual : 0}%</div>`;
      }

      function createMonitorItem(locker, meta) {
        const item = document.createElement('article');
        item.className = 'monitor-item';
        item.style.borderLeftColor = meta.accent;

        const header = document.createElement('header');
        header.className = 'monitor-item__header';

        const title = document.createElement('span');
        title.className = 'monitor-item__title';
        title.innerHTML = formatCell(locker.armario);

        const badge = document.createElement('span');
        badge.className = 'monitor-item__badge';
        badge.textContent = locker.status ? locker.status : meta.badgeText;
        badge.style.color = meta.accent;
        badge.style.backgroundColor = meta.badgeBackground;

        header.appendChild(title);
        header.appendChild(badge);
        item.appendChild(header);

        const body = document.createElement('div');
        body.className = 'monitor-item__body';

        appendMonitorRow(body, 'Unidade', formatCell(locker.unidade));
        appendMonitorRow(body, 'Capacidade', formatCell(locker.capacidade));

        const registro = locker.registro || null;
        const hasRegistro = registro && Object.values(registro).some((value) => value);

        if (hasRegistro) {
          appendMonitorRow(body, 'Perfil', formatCell(registro.perfil));
          if (registro.responsavel || registro.contato) {
            let responsavel = formatCell(registro.responsavel);
            if (registro.contato) {
              responsavel += `<span class="monitor-item__meta">${escapeHtml(registro.contato)}</span>`;
            }
            appendMonitorRow(body, 'Responsável', responsavel, { multiline: true, allowPlaceholder: true });
          }
          appendMonitorRow(body, 'Paciente', formatCell(registro.paciente));
          appendMonitorRow(body, 'Itens guardados', formatMultiline(registro.itens), { multiline: true });
          appendMonitorRow(body, 'Registrado', formatCell(registro.criadoEm));
        } else if (meta.key === 'livre') {
          appendMonitorRow(
            body,
            'Disponibilidade',
            '<span class="monitor-item__empty">Disponível para novo registro.</span>',
            { multiline: true, allowPlaceholder: true }
          );
        }

        const notes = collectMonitorNotes(locker);
        if (notes.length) {
          const notesElement = document.createElement('div');
          notesElement.className = 'monitor-item__notes';
          notesElement.innerHTML = notes.join('<br />');
          item.appendChild(body);
          item.appendChild(notesElement);
        } else {
          item.appendChild(body);
        }

        return item;
      }

      function appendMonitorRow(container, label, value, options = {}) {
        const settings = { multiline: false, allowPlaceholder: false, ...options };
        if (!settings.allowPlaceholder && (!value || value === '—')) {
          return;
        }
        const row = document.createElement('div');
        row.className = 'monitor-item__row';
        if (settings.multiline) {
          row.classList.add('monitor-item__row--multiline');
        }
        row.innerHTML = `
          <span class="monitor-item__label">${label}</span>
          <span class="monitor-item__value">${value}</span>
        `;
        container.appendChild(row);
      }

      function collectMonitorNotes(locker) {
        const notes = [];
        [locker.descricao, locker.observacoes, locker.registro && locker.registro.observacoes]
          .filter(Boolean)
          .forEach((note) => {
            const formatted = formatMultiline(note);
            if (formatted && formatted !== '—') {
              notes.push(formatted);
            }
          });
        return notes;
      }

      function simplifyStatus(value) {
        if (!value) return '';
        const str = String(value).trim();
        try {
          return str
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .toLowerCase();
        } catch (error) {
          return str.toLowerCase();
        }
      }

      function getStatusMeta(statusValue) {
        const presets = {
          ocupado: {
            key: 'ocupado',
            columnTitle: 'Em uso',
            badgeText: 'Em uso',
            accent: 'var(--danger)',
            badgeBackground: 'rgba(214, 69, 69, 0.15)',
            emptyMessage: 'Nenhum armário em uso no momento.',
            order: 0,
          },
          reservado: {
            key: 'reservado',
            columnTitle: 'Reservados',
            badgeText: 'Reservado',
            accent: 'var(--primary)',
            badgeBackground: 'rgba(25, 113, 194, 0.14)',
            emptyMessage: 'Nenhum armário reservado.',
            order: 1,
          },
          manutencao: {
            key: 'manutencao',
            columnTitle: 'Em manutenção',
            badgeText: 'Indisponível',
            accent: 'var(--warning)',
            badgeBackground: 'rgba(249, 115, 22, 0.16)',
            emptyMessage: 'Nenhum armário em manutenção.',
            order: 2,
          },
          livre: {
            key: 'livre',
            columnTitle: 'Disponíveis',
            badgeText: 'Disponível',
            accent: 'var(--success)',
            badgeBackground: 'rgba(47, 158, 68, 0.15)',
            emptyMessage: 'Todos os armários estão ocupados.',
            order: 3,
          },
        };

        const raw = statusValue ? String(statusValue).trim() : '';
        const simplified = simplifyStatus(raw);

        if (!raw) {
          return presets.livre;
        }

        if (simplified.includes('ocup')) {
          return presets.ocupado;
        }
        if (simplified.includes('reserv')) {
          return presets.reservado;
        }
        if (simplified.includes('manut')) {
          return presets.manutencao;
        }
        if (simplified.includes('livr') || simplified.includes('dispon')) {
          return presets.livre;
        }

        return {
          key: simplified || 'outros',
          columnTitle: capitalizeStatus(raw || 'Outros'),
          badgeText: raw || 'Status',
          accent: 'var(--primary)',
          badgeBackground: 'rgba(25, 113, 194, 0.14)',
          emptyMessage: `Nenhum armário com status ${raw.toLowerCase()}.`,
          order: 4,
        };
      }

      function capitalizeStatus(value) {
        if (!value) return '';
        return value
          .toLowerCase()
          .split(' ')
          .filter(Boolean)
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(' ');
      }

      function renderStatus(status) {
        const normalized = (status || '').toLowerCase();
        const classes = ['status'];
        if (normalized === 'finalizado') {
          classes.push('status--finalizado');
        } else {
          classes.push('status--ativo');
        }
        return `<span class="${classes.join(' ')}">${escapeHtml(status || 'Ativo')}</span>`;
      }

      function renderActions(entry) {
        const isActive = (entry.status || '').toLowerCase() !== 'finalizado';
        const buttons = [];
        if (isActive) {
          buttons.push(`<button class="btn--table" data-action="finalize" data-id="${entry.id}">Encerrar</button>`);
        } else {
          buttons.push(`<button class="btn--table" data-action="reopen" data-id="${entry.id}">Reabrir</button>`);
        }
        buttons.push(`<button class="btn--table" data-action="delete" data-id="${entry.id}">Excluir</button>`);
        return `<div class="actions">${buttons.join('')}</div>`;
      }

      function escapeHtml(value) {
        if (value === null || value === undefined) return '';
        return String(value)
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      function formatCell(value) {
        const safe = escapeHtml(value);
        return safe || '—';
      }

      function formatMultiline(value) {
        const safe = escapeHtml(value);
        if (!safe) return '—';
        return safe.replace(/\n/g, '<br />');
      }

      function renderContact(value) {
        const safe = escapeHtml(value);
        return safe ? `<span class="table-meta">${safe}</span>` : '';
      }

      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());
        Object.keys(payload).forEach((key) => {
          if (typeof payload[key] === 'string') {
            payload[key] = payload[key].trim();
          }
        });
        if (payload.armario) {
          payload.armario = payload.armario.toUpperCase();
        }
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          alert('Este formulário precisa ser executado dentro do Google Apps Script publicado.');
          return;
        }
        setLoading(true);
        google.script.run
          .withSuccessHandler(() => {
            form.reset();
            setLoading(false);
            fetchData();
          })
          .withFailureHandler((err) => {
            console.error(err);
            setLoading(false);
            const message = err && err.message ? err.message : 'Não foi possível salvar. Tente novamente.';
            alert(message);
          })
          .addEntry(payload);
      });

      refreshButton.addEventListener('click', () => {
        fetchData();
      });

      unitFilter.addEventListener('change', () => {
        state.filters.unidade = unitFilter.value;
        if (!state.filters.unidade) {
          state.filters.perfil = '';
        } else if (!getProfilesForUnit(state.filters.unidade).includes(state.filters.perfil)) {
          state.filters.perfil = '';
        }
        renderFilters();
        renderTable();
        renderMonitor();
      });

      profileFilter.addEventListener('change', () => {
        state.filters.perfil = profileFilter.value;
        renderTable();
        renderMonitor();
      });

      tableBody.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const action = target.getAttribute('data-action');
        const id = target.getAttribute('data-id');
        if (!action || !id) return;
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          alert('Ações de registro disponíveis somente na versão publicada.');
          return;
        }
        if (action === 'finalize') {
          const note = prompt('Alguma observação para o encerramento? (opcional)');
          google.script.run
            .withSuccessHandler(fetchData)
            .withFailureHandler((err) => {
              console.error(err);
              const message = err && err.message ? err.message : 'Não foi possível encerrar o registro.';
              alert(message);
            })
            .finalizeEntry({ id, nota: note || '' });
        }
        if (action === 'reopen') {
          google.script.run
            .withSuccessHandler(fetchData)
            .withFailureHandler((err) => {
              console.error(err);
              const message = err && err.message ? err.message : 'Não foi possível reabrir o registro.';
              alert(message);
            })
            .reopenEntry({ id });
        }
        if (action === 'delete') {
          const confirmed = confirm('Confirma remover este registro? Esta ação é definitiva.');
          if (!confirmed) return;
          google.script.run
            .withSuccessHandler(fetchData)
            .withFailureHandler((err) => {
              console.error(err);
              const message = err && err.message ? err.message : 'Não foi possível excluir o registro.';
              alert(message);
            })
            .deleteEntry({ id });
        }
      });

      document.addEventListener('DOMContentLoaded', () => {
        fetchData();
      });
    </script>
  </body>
</html>
