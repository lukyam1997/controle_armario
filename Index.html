<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Hospital Storage Manager</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

    :root {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      transition: background 0.3s ease, color 0.3s ease;
    }

    body[data-theme="light"] {
      --bg: #f3f4f6;
      --bg-soft: #eef2ff;
      --surface: #ffffff;
      --surface-elevated: #f9fafb;
      --surface-translucent: rgba(255,255,255,0.85);
      --text: #0f172a;
      --text-muted: #64748b;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --success: #22c55e;
      --warning: #f97316;
      --danger: #ef4444;
      --info: #0ea5e9;
      --border: rgba(15,23,42,0.08);
      --shadow: 0 25px 45px rgba(15,23,42,0.08);
      --sidebar-bg: #0f172a;
      --sidebar-active: rgba(37,99,235,0.16);
      --sidebar-text: #e2e8f0;
      --sidebar-muted: rgba(226,232,240,0.55);
    }

    body[data-theme="dark"] {
      --bg: #0b1120;
      --bg-soft: #111c36;
      --surface: rgba(15,23,42,0.88);
      --surface-elevated: rgba(15,23,42,0.92);
      --surface-translucent: rgba(15,23,42,0.75);
      --text: #e2e8f0;
      --text-muted: #94a3b8;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --success: #4ade80;
      --warning: #fb923c;
      --danger: #f87171;
      --info: #38bdf8;
      --border: rgba(148,163,184,0.18);
      --shadow: 0 25px 45px rgba(2,6,23,0.55);
      --sidebar-bg: rgba(15,23,42,0.95);
      --sidebar-active: rgba(59,130,246,0.18);
      --sidebar-text: #f8fafc;
      --sidebar-muted: rgba(148,163,184,0.7);
      backdrop-filter: blur(16px);
      background: radial-gradient(circle at top left, #1e3a8a 0%, #0b1120 55%);
    }

    body[data-theme="light"] {
      background: radial-gradient(circle at top right, #e0e7ff 0%, #f3f4f6 55%);
    }

    * {
      box-sizing: border-box;
    }

    .login-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 40px 16px;
      position: relative;
    }

    .login-card {
      width: 100%;
      max-width: 420px;
      background: var(--surface-translucent);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: 24px;
      padding: 36px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      backdrop-filter: blur(18px);
    }

    .login-brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .login-logo {
      width: 72px;
      height: 72px;
      border-radius: 16px;
      object-fit: cover;
      background: #fff;
      box-shadow: var(--shadow);
      padding: 6px;
    }

    .login-brand h2 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--text);
    }

    .login-description {
      margin: 0;
      color: var(--text-muted);
      line-height: 1.5;
      font-size: 0.96rem;
    }

    .login-form label {
      display: block;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text);
    }

    .login-form input {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text);
      font-size: 1rem;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    .login-form input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
    }

    .btn-primary {
      width: 100%;
      padding: 14px 18px;
      border-radius: 12px;
      border: none;
      font-weight: 600;
      font-size: 1rem;
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      color: #fff;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .theme-switch {
      position: absolute;
      top: 32px;
      right: 32px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface-translucent);
      color: var(--text);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      backdrop-filter: blur(16px);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .theme-switch:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .message {
      padding: 12px 14px;
      border-radius: 12px;
      font-weight: 600;
      text-align: center;
    }

    .message.error {
      background: rgba(239,68,68,0.14);
      color: var(--danger);
      border: 1px solid rgba(239,68,68,0.24);
    }

    .app {
      display: flex;
      min-height: 100vh;
      width: 100%;
      overflow: hidden;
      background: transparent;
    }

    .sidebar {
      width: 280px;
      background: var(--sidebar-bg);
      color: var(--sidebar-text);
      display: flex;
      flex-direction: column;
      padding: 28px 24px 24px;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 28px;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .sidebar-logo img {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      object-fit: cover;
      background: #fff;
      box-shadow: var(--shadow);
      padding: 4px;
    }

    .sidebar .theme-switch.small {
      position: static;
      padding: 8px 10px;
      font-size: 0.85rem;
      color: var(--sidebar-text);
      border-color: rgba(255,255,255,0.14);
      background: rgba(15,23,42,0.6);
    }

    .sidebar-nav {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 24px;
      overflow-y: auto;
    }

    .sidebar-section {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar-section .section-title {
      font-size: 0.75rem;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--sidebar-muted);
      font-weight: 600;
    }

    .nav-item,
    .sidebar .logout,
    .admin-link {
      width: 100%;
      background: transparent;
      border: none;
      color: inherit;
      padding: 12px 14px;
      border-radius: 12px;
      font-size: 0.95rem;
      text-align: left;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .nav-item:hover,
    .admin-link:hover {
      background: rgba(255,255,255,0.08);
    }

    .nav-item.active {
      background: var(--sidebar-active);
      color: #fff;
    }

    .sidebar .logout {
      margin-top: auto;
      justify-content: center;
      font-weight: 700;
      color: #fca5a5;
      border: 1px solid rgba(248,113,113,0.35);
      background: rgba(248,113,113,0.08);
    }

    .workspace {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: transparent;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(18px);
      background: var(--surface-translucent);
      border-bottom: 1px solid var(--border);
      padding: 20px 32px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
    }

    .topbar-left {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .topbar-title-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
    }

    #viewTitle {
      margin: 0;
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text);
    }

    .current-unit {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 14px;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid var(--border);
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      transition: background 0.2s ease, color 0.2s ease, border 0.2s ease;
    }

    .current-unit.has-value {
      color: var(--text);
      background: var(--surface-elevated);
    }

    .unit-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .unit-selector:empty::after {
      content: 'Nenhuma unidade dispon√≠vel';
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .unit-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface);
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
      box-shadow: 0 12px 30px rgba(15,23,42,0.08);
    }

    .unit-pill .unit-icon {
      display: grid;
      place-items: center;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--primary-hover));
      color: #fff;
      font-size: 0.95rem;
    }

    .unit-pill:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .unit-pill.active {
      background: var(--primary);
      color: #fff;
      border-color: transparent;
      box-shadow: 0 18px 34px rgba(37,99,235,0.32);
    }

    .unit-pill[disabled],
    .unit-pill[aria-disabled="true"] {
      cursor: default;
      opacity: 0.75;
      transform: none;
      box-shadow: none;
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .icon-button {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      display: grid;
      place-items: center;
      color: var(--text);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .icon-button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .notification {
      position: relative;
      cursor: pointer;
    }

    .notification-count {
      position: absolute;
      top: -6px;
      right: -6px;
      min-width: 20px;
      height: 20px;
      border-radius: 999px;
      background: var(--danger);
      color: #fff;
      font-size: 0.7rem;
      display: grid;
      place-items: center;
      font-weight: 700;
      padding: 0 6px;
    }

    .user-chip {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      font-weight: 600;
    }

    .user-chip span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: rgba(59,130,246,0.18);
      color: var(--primary);
      font-weight: 700;
    }

    .main {
      flex: 1;
      padding: 32px 32px 48px;
      background: transparent;
      overflow-y: auto;
    }

    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .stat-card {
      border-radius: 18px;
      padding: 22px;
      background: var(--surface);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 8px;
      color: var(--text);
    }

    .stat-card strong {
      font-size: 1.8rem;
      font-weight: 700;
    }

    .stat-card span {
      font-size: 0.95rem;
      color: var(--text-muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .card {
      background: var(--surface);
      border-radius: 22px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      padding: 28px;
      margin-bottom: 24px;
    }

    .dashboard-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-end;
      margin-bottom: 24px;
    }

    .control {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 180px;
    }

    .toggle-group {
      display: inline-flex;
      gap: 8px;
      padding: 4px;
      border-radius: 14px;
      background: var(--surface);
      border: 1px solid var(--border);
    }

    .toggle-group .toggle {
      border: none;
      padding: 10px 18px;
      border-radius: 12px;
      background: transparent;
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .toggle-group .toggle.active {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 10px 22px rgba(37,99,235,0.28);
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
      font-size: 0.85rem;
      font-weight: 600;
    }

    .tag.muted {
      color: var(--text-muted);
      background: transparent;
    }

    .checkbox-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .checkbox-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--surface);
      cursor: pointer;
      transition: background 0.2s ease, border 0.2s ease, box-shadow 0.2s ease;
    }

    .checkbox-pill input {
      width: auto;
      accent-color: var(--primary);
    }

    .checkbox-pill:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow);
    }

    .report-filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .summary-card {
      padding: 18px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .summary-card strong {
      font-size: 1.4rem;
    }

    .indicator-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 18px;
    }

    .indicator-card {
      padding: 20px;
      border-radius: 18px;
      border: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .indicator-card h3 {
      margin: 0;
      font-size: 1rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .indicator-card strong {
      font-size: 1.6rem;
      color: var(--text);
    }

    .empty-state {
      padding: 32px;
      border-radius: 18px;
      border: 1px dashed var(--border);
      background: var(--surface);
      text-align: center;
      color: var(--text-muted);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .card h2 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--text);
    }

    .locker-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 18px;
    }

    .locker-grid .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      font-weight: 600;
      color: var(--text-muted);
      padding: 40px 0;
    }

    .loading-indicator {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      animation: spin 0.9s linear infinite;
    }

    .locker {
      border-radius: 18px;
      padding: 20px 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.05rem;
      text-align: center;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .locker small {
      font-weight: 500;
      margin-top: 8px;
      font-size: 0.8rem;
    }

    .locker::after {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: linear-gradient(135deg, rgba(255,255,255,0.12), transparent 55%);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .locker:hover {
      transform: translateY(-6px) scale(1.02);
      box-shadow: var(--shadow);
    }

    .locker:hover::after {
      opacity: 1;
    }

    .locker.status-Free {
      background: rgba(34,197,94,0.16);
      color: var(--success);
    }

    .locker.status-InUse {
      background: rgba(14,165,233,0.16);
      color: var(--info);
    }

    .locker.status-DueSoon {
      background: rgba(249,115,22,0.16);
      color: var(--warning);
    }

    .locker.status-Overdue {
      background: rgba(239,68,68,0.16);
      color: var(--danger);
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 24px;
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    .legend span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--surface-elevated);
      border: 1px solid var(--border);
    }

    .config-hint {
      margin: 12px 0 0;
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    table {
      width: 100%;
      border-collapse: collapse;
      color: var(--text);
    }

    th,
    td {
      padding: 12px 10px;
      border-bottom: 1px solid var(--border);
      font-size: 0.92rem;
      text-align: left;
    }

    th {
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-size: 0.78rem;
      color: var(--text-muted);
    }

    input,
    select,
    button,
    textarea {
      font-family: inherit;
    }

    input,
    select,
    textarea {
      width: 100%;
      padding: 12px 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
      color: var(--text);
      margin-bottom: 12px;
    }

    select {
      appearance: none;
      background-image: linear-gradient(45deg, transparent 50%, var(--text-muted) 50%),
                        linear-gradient(135deg, var(--text-muted) 50%, transparent 50%);
      background-position: calc(100% - 18px) calc(1.1em), calc(100% - 12px) calc(1.1em);
      background-size: 6px 6px;
      background-repeat: no-repeat;
      padding-right: 36px;
    }

    button {
      cursor: pointer;
    }

    .btn-secondary {
      background: rgba(148,163,184,0.16);
      color: var(--text);
      border-radius: 12px;
      padding: 12px 16px;
      border: 1px solid var(--border);
      font-weight: 600;
      transition: transform 0.2s ease;
    }

    .btn-secondary:hover {
      transform: translateY(-2px);
    }

    .btn-danger {
      background: rgba(239,68,68,0.16);
      color: var(--danger);
      border: 1px solid rgba(239,68,68,0.4);
      border-radius: 12px;
      padding: 12px 16px;
      font-weight: 600;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15,23,42,0.55);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      padding: 24px;
      z-index: 999;
    }

    .modal.active {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-content {
      width: min(540px, 100%);
      border-radius: 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 28px;
      position: relative;
      box-shadow: var(--shadow);
      max-height: 85vh;
      overflow-y: auto;
    }

    .modal-close {
      position: absolute;
      top: 16px;
      right: 16px;
      font-size: 1.4rem;
      color: var(--text-muted);
      cursor: pointer;
    }

    @media (max-width: 1024px) {
      .sidebar {
        width: 240px;
      }
      .topbar {
        padding: 18px 20px;
      }
      .main {
        padding: 24px;
      }
    }

    @media (max-width: 768px) {
      .app {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        overflow-x: auto;
        gap: 18px;
      }
      .sidebar-nav {
        flex-direction: row;
        gap: 18px;
      }
      .sidebar-section {
        min-width: 220px;
      }
      .workspace {
        padding-top: 12px;
      }
      .topbar {
        flex-direction: column;
        align-items: flex-start;
      }
      .topbar-title-row {
        width: 100%;
        justify-content: space-between;
      }
      .current-unit {
        width: 100%;
        justify-content: center;
      }
      .unit-selector {
        width: 100%;
      }
      .unit-selector .unit-pill {
        flex: 1 1 auto;
      }
      .topbar-actions {
        width: 100%;
        justify-content: space-between;
      }
      .main {
        padding: 20px;
      }
    }
  </style>
</head>
<body data-theme="light">
  <div id="loginPage" class="login-page">
    <button id="loginThemeToggle" class="theme-switch" type="button" onclick="toggleTheme()">üåô Modo escuro</button>
    <div class="login-card">
      <div class="login-brand">
        <img src="https://i.ibb.co/hxbRMNvV/logo-HUC.jpg" alt="Hospital de Urg√™ncia de Campina Grande" class="login-logo" />
        <div>
          <h2>Controle de Arm√°rios</h2>
          <p class="login-description">Organize lockers de visitantes e acompanhantes em uma experi√™ncia moderna, com monitoramento em tempo real.</p>
        </div>
      </div>
      <form id="loginForm" class="login-form" onsubmit="submitLogin(event)">
        <div>
          <label for="username">Usu√°rio</label>
          <input id="username" autocomplete="username" required />
        </div>
        <div>
          <label for="password">Senha</label>
          <input type="password" id="password" autocomplete="current-password" required />
        </div>
        <button class="btn-primary" type="submit">Entrar</button>
      </form>
      <div id="loginError" class="message error" style="display:none;"></div>
    </div>
  </div>

  <div id="app" class="app" style="display:none;">
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo"><img src="https://i.ibb.co/hxbRMNvV/logo-HUC.jpg" alt="HUC" /> Controle HUC</div>
        <button id="sidebarThemeToggle" class="theme-switch small" type="button" onclick="toggleTheme()">üåô</button>
      </div>
      <nav class="sidebar-nav">
        <div class="sidebar-section">
          <span class="section-title">Vis√£o geral</span>
          <button class="nav-item" data-view="visitor" onclick="playSound('click');loadDashboard('visitor')">üë• Arm√°rios Visitantes</button>
          <button class="nav-item" data-view="companion" onclick="playSound('click');loadDashboard('companion')">üß≥ Arm√°rios Acompanhantes</button>
          <button class="nav-item" data-view="indicators" onclick="playSound('click');showIndicators()">üìà Indicadores</button>
        </div>
        <div id="adminSection" class="sidebar-section" style="display:none;">
          <span class="section-title">Administra√ß√£o</span>
          <button class="admin-link" onclick="playSound('click');showLockerSettings()">‚öôÔ∏è Configura√ß√µes de Arm√°rios</button>
          <button class="admin-link" onclick="playSound('click');showUnitSettings()">üè¢ Unidades</button>
          <button class="admin-link" onclick="playSound('click');showUsers()">üë§ Usu√°rios</button>
          <button class="admin-link" onclick="playSound('click');showReports()">üìä Relat√≥rios</button>
          <button class="admin-link" onclick="playSound('click');showAudit()">üìù Auditoria</button>
        </div>
      </nav>
      <button class="logout" onclick="handleLogout()">Sair</button>
    </aside>
    <div class="workspace">
      <header class="topbar">
        <div class="topbar-left">
          <div class="topbar-title-row">
            <h1 id="viewTitle">Painel</h1>
            <span id="currentUnitLabel" class="current-unit">Selecione uma unidade</span>
          </div>
          <div class="unit-selector" id="unitSelector"></div>
        </div>
        <div class="topbar-actions">
          <button id="headerThemeToggle" class="icon-button" type="button" onclick="toggleTheme()">üåô</button>
          <div class="notification" onclick="showNotifications()">
            <span id="notifIcon" class="icon-button" style="width:44px;height:44px;display:grid;place-items:center;">üîî</span>
            <span id="notifCount" class="notification-count" style="display:none;">0</span>
          </div>
          <div id="userChip" class="user-chip" style="display:none;"></div>
        </div>
      </header>
      <main class="main" id="mainContent"></main>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <div id="modalBody"></div>
    </div>
  </div>

<script>
const savedTheme = (()=>{ try { return localStorage.getItem('lockerTheme') || 'light'; } catch(e){ return 'light'; }})();
document.body.setAttribute('data-theme', savedTheme);

const state = {
  user: null,
  view: 'visitor',
  currentUnit: null,
  units: [],
  availableUnits: [],
  notifications: [],
  theme: savedTheme,
  activePage: 'dashboard',
  dashboardFilters: { status: 'all', query: '' },
  reportFilters: { type: 'all', action: 'all', status: 'all', units: [], start: '', end: '', query: '' },
  indicatorFilters: { type: 'all', units: [], days: 30 },
  lockerCache: { type: null, unit: null, rows: null }
};

let audioCtx = null;
let audioReady = false;
const SOUND_LIBRARY = {
  click: [
    { freq: 420, duration: 0.08, type: 'square', volume: 0.16 },
    { freq: 640, duration: 0.06, type: 'triangle', volume: 0.12, delay: 0.08 }
  ],
  success: [
    { freq: 520, duration: 0.12, type: 'sine', volume: 0.14 },
    { freq: 720, duration: 0.14, type: 'triangle', volume: 0.12, delay: 0.1 },
    { freq: 880, duration: 0.16, type: 'sine', volume: 0.1, delay: 0.24 }
  ],
  error: [
    { freq: 200, duration: 0.22, type: 'sawtooth', volume: 0.22 },
    { freq: 140, duration: 0.18, type: 'triangle', volume: 0.16, delay: 0.22 }
  ],
  modal: [
    { freq: 560, duration: 0.12, type: 'triangle', volume: 0.12 },
    { freq: 430, duration: 0.1, type: 'sine', volume: 0.1, delay: 0.14 }
  ],
  notice: [
    { freq: 640, duration: 0.14, type: 'sine', volume: 0.12 },
    { freq: 860, duration: 0.14, type: 'square', volume: 0.1, delay: 0.16 }
  ],
  insight: [
    { freq: 480, duration: 0.16, type: 'triangle', volume: 0.14 },
    { freq: 720, duration: 0.12, type: 'sine', volume: 0.12, delay: 0.18 },
    { freq: 960, duration: 0.18, type: 'triangle', volume: 0.1, delay: 0.32 }
  ]
};

function ensureAudioContext(){
  const Ctx = window.AudioContext || window.webkitAudioContext;
  if (!Ctx) return null;
  if (!audioCtx) audioCtx = new Ctx();
  return audioCtx;
}

function enableAudio(){
  const ctx = ensureAudioContext();
  if (!ctx) return;
  if (audioReady) return;
  const resume = ctx.state === 'suspended' ? ctx.resume() : Promise.resolve();
  resume.then(()=>{ audioReady = true; }).catch(()=>{});
}

window.addEventListener('pointerdown', ()=>{
  enableAudio();
}, { once: true });

function playSound(name){
  const ctx = ensureAudioContext();
  if (!ctx) return;
  if (!audioReady) {
    const resume = ctx.state === 'suspended' ? ctx.resume() : Promise.resolve();
    resume.then(()=>{
      audioReady = true;
      playSound(name);
    }).catch(()=>{});
    return;
  }
  const tones = SOUND_LIBRARY[name];
  if (!tones || !tones.length) return;
  const now = ctx.currentTime;
  tones.forEach(tone=>{
    const start = now + (tone.delay || 0);
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = tone.type || 'sine';
    osc.frequency.setValueAtTime(tone.freq, start);
    const volume = Math.max(0.001, tone.volume || 0.12);
    gain.gain.setValueAtTime(0.0001, start);
    gain.gain.linearRampToValueAtTime(volume, start + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, start + tone.duration);
    osc.connect(gain).connect(ctx.destination);
    osc.start(start);
    osc.stop(start + tone.duration + 0.04);
  });
}

const PROFILES = {
  ADMIN: 'admin',
  VISITOR: 'armario_visitante',
  COMPANION: 'guarda_volume',
};

function toggleTheme(){
  playSound('click');
  state.theme = state.theme === 'light' ? 'dark' : 'light';
  applyTheme(state.theme);
}

function applyTheme(theme){
  state.theme = theme;
  document.body.setAttribute('data-theme', theme);
  try { localStorage.setItem('lockerTheme', theme); } catch(e){}
  updateThemeButtons();
}

function updateThemeButtons(){
  const label = state.theme === 'dark' ? 'üåû Modo claro' : 'üåô Modo escuro';
  const icon = state.theme === 'dark' ? 'üåû' : 'üåô';
  const loginBtn = document.getElementById('loginThemeToggle');
  if (loginBtn) loginBtn.textContent = label;
  const sidebarBtn = document.getElementById('sidebarThemeToggle');
  if (sidebarBtn) sidebarBtn.textContent = icon;
  const headerBtn = document.getElementById('headerThemeToggle');
  if (headerBtn) headerBtn.textContent = icon;
}

updateThemeButtons();

function escapeHtml(value){
  if (value === null || value === undefined) return '';
  return String(value).replace(/[&<>"']/g, ch => ({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;' }[ch]));
}

function describeMetadata(meta){
  if (!meta || typeof meta !== 'object') return '';
  const parts = [];
  Object.keys(meta).forEach(key=>{
    let value = meta[key];
    if (value === null || value === undefined) value = '';
    else if (typeof value === 'object') {
      try { value = JSON.stringify(value); }
      catch (err) { value = String(value); }
    }
    parts.push(`${key}: ${value}`);
  });
  return escapeHtml(parts.join(' | '));
}

function submitLogin(e){
  e.preventDefault();
  playSound('click');
  const username = document.getElementById('username').value.trim();
  const password = document.getElementById('password').value;
  document.getElementById('loginError').style.display = 'none';

  google.script.run
    .withSuccessHandler(res=>{
      if (res && res.success) {
        playSound('success');
        setupAfterLogin(res);
      } else {
        playSound('error');
        showError('loginError', (res && res.message) || 'Falha ao autenticar.');
      }
    })
    .withFailureHandler(err=>{
      playSound('error');
      showError('loginError', 'Erro de comunica√ß√£o: '+err.message);
    })
    .login(username, password);
}

function setupAfterLogin(user){
  const units = Array.isArray(user.units) ? user.units : (user.defaultUnit ? [user.defaultUnit] : (user.unit ? [user.unit] : []));
  state.user = Object.assign({}, user, { units });
  state.view = 'visitor';
  document.getElementById('loginPage').style.display = 'none';
  document.getElementById('app').style.display = 'flex';
  updateThemeButtons();
  renderUserChip();
  state.dashboardFilters = { status: 'all', query: '' };
  state.reportFilters = { type: 'all', action: 'all', status: 'all', units: units.slice(), start: '', end: '', query: '' };
  state.indicatorFilters = { type: 'all', units: units.slice(), days: 30 };
  loadUnitsAndStart(true);
}

function renderUserChip(){
  const chip = document.getElementById('userChip');
  if (!chip || !state.user) return;
  const initials = (state.user.username || '?').substring(0,2).toUpperCase();
  chip.innerHTML = `<span>${initials}</span>${state.user.username}`;
  chip.style.display = 'flex';
}

function handleLogout(){
  playSound('click');
  state.user = null;
  state.units = [];
  state.currentUnit = null;
  state.availableUnits = [];
  state.notifications = [];
  state.activePage = 'dashboard';
  state.dashboardFilters = { status: 'all', query: '' };
  state.reportFilters = { type: 'all', action: 'all', status: 'all', units: [], start: '', end: '', query: '' };
  state.indicatorFilters = { type: 'all', units: [], days: 30 };
  state.lockerCache = { type: null, unit: null, rows: null };
  document.getElementById('app').style.display = 'none';
  document.getElementById('loginPage').style.display = 'flex';
  document.getElementById('loginForm').reset();
  document.getElementById('userChip').style.display = 'none';
  updateThemeButtons();
  updateNotificationBell();
  updateUnitSelector();
}

function showError(elId, msg){
  const el = document.getElementById(elId);
  if (!el) return;
  el.textContent = msg;
  el.style.display = 'block';
}

function loadUnitsAndStart(reloadDashboard = true, callback){
  google.script.run.withSuccessHandler(units=>{
    state.units = units || [];
    const currentName = state.currentUnit ? state.currentUnit.name : '';
    const assignedUnits = Array.isArray(state.user && state.user.units) ? state.user.units : [];
    let availableUnits = [];
    if (isAdmin()) {
      availableUnits = state.units.slice();
    } else if (assignedUnits.length) {
      availableUnits = state.units.filter(u=>assignedUnits.includes(u.name));
      assignedUnits.forEach(name => {
        if (!availableUnits.find(u=>u.name === name)) {
          availableUnits.push({ name, display: name });
        }
      });
    }
    state.availableUnits = availableUnits;

    const findInList = (arr, name) => (arr || []).find(u=>u.name === name) || null;
    let nextUnit = currentName ? findInList(availableUnits, currentName) || findInList(state.units, currentName) : null;
    if (!nextUnit && assignedUnits.length) {
      nextUnit = assignedUnits
        .map(name => findInList(availableUnits, name) || findInList(state.units, name))
        .find(Boolean) || null;
    }
    if (!nextUnit) {
      nextUnit = availableUnits[0] || state.units[0] || null;
    }
    state.currentUnit = nextUnit;

    const availableNames = availableUnits.map(u=>u.name);
    state.reportFilters.units = state.reportFilters.units.filter(name => availableNames.includes(name));
    if (!state.reportFilters.units.length && availableNames.length) {
      state.reportFilters.units = availableNames.slice();
    }
    state.indicatorFilters.units = state.reportFilters.units.slice();

    updateAdminVisibility();
    updateUnitSelector();
    updateNavigation();

    if (reloadDashboard) {
      loadDashboard(state.view || 'visitor');
    } else if (typeof callback === 'function') {
      callback();
    }
  }).listUnits();
}

function findUnit(name){
  if (!name) return null;
  const fromAvailable = (state.availableUnits || []).find(u=>u.name === name);
  if (fromAvailable) return fromAvailable;
  const fromAll = (state.units || []).find(u=>u.name === name);
  return fromAll || null;
}

function isAdmin(){
  return state.user && state.user.profile === PROFILES.ADMIN;
}

function updateAdminVisibility(){
  const section = document.getElementById('adminSection');
  if (section) section.style.display = isAdmin() ? 'flex' : 'none';
}

function updateUnitSelector(){
  const label = document.getElementById('currentUnitLabel');
  if (label) {
    if (state.currentUnit) {
      label.textContent = `Unidade ¬∑ ${state.currentUnit.display}`;
      label.classList.add('has-value');
    } else {
      label.textContent = 'Selecione uma unidade';
      label.classList.remove('has-value');
    }
  }
  refreshUnitsMenu();
}

function handleUnitChange(name){
  changeUnit(name);
}

function refreshUnitsMenu(){
  const container = document.getElementById('unitSelector');
  if (!container) return;
  const units = isAdmin() ? state.units : (state.availableUnits || []);
  if (!units.length){
    container.innerHTML = '';
    return;
  }
  const disableSelection = !isAdmin() && units.length <= 1;
  container.innerHTML = units.map(u=>{
    const active = state.currentUnit && state.currentUnit.name === u.name;
    const escapedName = u.name.replace(/'/g, "\\'");
    const disabledAttr = disableSelection && active ? 'disabled aria-disabled="true"' : '';
    const action = disabledAttr ? '' : `onclick="changeUnit('${escapedName}')"`;
    return `<button class="unit-pill ${active?'active':''}" type="button" ${disabledAttr} ${action}><span class="unit-icon">üè•</span><span>${u.display}</span></button>`;
  }).join('');
}

function changeUnit(name){
  const unit = findUnit(name);
  if (!unit) return;
  playSound('click');
  state.currentUnit = unit;
  state.lockerCache = { type: null, unit: null, rows: null };
  updateUnitSelector();
  goToCurrentPage();
}

function goToCurrentPage(){
  switch (state.activePage) {
    case 'dashboard':
      loadDashboard(state.view);
      break;
    case 'settings':
      showLockerSettings();
      break;
    case 'units':
      showUnitSettings();
      break;
    case 'users':
      showUsers();
      break;
    case 'reports':
      showReports();
      break;
    case 'audit':
      showAudit();
      break;
    case 'indicators':
      showIndicators();
      break;
    default:
      loadDashboard(state.view);
  }
}

function updateNavigation(){
  const buttons = document.querySelectorAll('.nav-item');
  buttons.forEach(btn=>{
    if (btn.dataset.view === state.view) btn.classList.add('active');
    else btn.classList.remove('active');
  });
  let title;
  if (state.view === 'visitor') title = 'Arm√°rios de Visitantes';
  else if (state.view === 'companion') title = 'Arm√°rios de Acompanhantes';
  else if (state.view === 'indicators') title = 'Indicadores Operacionais';
  else title = 'Painel';
  const unitLabel = state.currentUnit ? ` ¬∑ ${state.currentUnit.display}` : '';
  const titleEl = document.getElementById('viewTitle');
  if (titleEl) titleEl.textContent = title + (state.view === 'indicators' ? '' : unitLabel);
}

function loadDashboard(type){
  state.view = type;
  state.activePage = 'dashboard';
  updateNavigation();
  const content = document.getElementById('mainContent');
  if (!content) return;
  state.notifications = [];
  updateNotificationBell();
  if (!state.currentUnit) {
    content.innerHTML = '<div class="card"><h2>Selecione uma unidade</h2><p>Para visualizar os arm√°rios, escolha uma unidade ativa.</p></div>';
    return;
  }
  const status = state.dashboardFilters.status || 'all';
  const queryValue = (state.dashboardFilters.query || '').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  content.innerHTML = `
    <section class="dashboard">
      <div class="dashboard-grid">
        <div class="stat-card" id="statCardFree"><span>Livres</span><strong id="statFree">0</strong></div>
        <div class="stat-card" id="statCardInUse"><span>Em uso</span><strong id="statInUse">0</strong></div>
        <div class="stat-card" id="statCardDueSoon"><span>Pr√≥ximo do hor√°rio</span><strong id="statDueSoon">0</strong></div>
        <div class="stat-card" id="statCardOverdue"><span>Vencidos</span><strong id="statOverdue">0</strong></div>
      </div>
      <div class="card">
        <div class="card-header">
          <h2>Monitor de arm√°rios</h2>
          <button class="btn-secondary" onclick="refreshCurrentView()">Atualizar</button>
        </div>
        <div class="dashboard-controls">
          <div class="control">
            <label>Perfil monitorado</label>
            <div class="toggle-group">
              <button class="toggle ${state.view === 'visitor' ? 'active' : ''}" type="button" onclick="switchDashboardScope('visitor')">Visitantes</button>
              <button class="toggle ${state.view === 'companion' ? 'active' : ''}" type="button" onclick="switchDashboardScope('companion')">Acompanhantes</button>
            </div>
          </div>
          <div class="control">
            <label>Status</label>
            <select id="dashboardStatus" onchange="handleDashboardStatusChange(this.value)">
              <option value="all"${status==='all'?' selected':''}>Todos</option>
              <option value="free"${status==='free'?' selected':''}>Somente livres</option>
              <option value="inuse"${status==='inuse'?' selected':''}>Em uso</option>
              <option value="duesoon"${status==='duesoon'?' selected':''}>A vencer</option>
              <option value="overdue"${status==='overdue'?' selected':''}>Vencidos</option>
            </select>
          </div>
          <div class="control" style="flex:1 1 240px;">
            <label>Busca r√°pida</label>
            <input id="dashboardQuery" placeholder="Nome, paciente ou arm√°rio" value="${queryValue}" oninput="handleDashboardQuery(this.value)" />
          </div>
        </div>
        <div class="locker-grid" id="grid"></div>
        <div class="legend">
          <span>üîì Livre</span>
          <span>üîí Em uso</span>
          <span>‚è≥ Pr√≥ximo do hor√°rio</span>
          <span>‚è∞ Vencido</span>
        </div>
      </div>
    </section>`;

  const unitName = state.currentUnit.name;
  state.lockerCache = { type: null, unit: null, rows: null };
  const grid = document.getElementById('grid');
  if (grid) grid.innerHTML = '<div class="loading"><div class="loading-indicator"></div><span>Carregando arm√°rios...</span></div>';
  ['statFree','statInUse','statDueSoon','statOverdue'].forEach(id=>{
    const el = document.getElementById(id);
    if (el) el.textContent = '‚Äî';
  });
  renderLockers(type, unitName);
  loadStats(type, unitName);
}

function refreshCurrentView(){
  playSound('click');
  loadDashboard(state.view);
}

function switchDashboardScope(scope){
  if (!scope || state.view === scope) return;
  playSound('click');
  loadDashboard(scope);
}

function handleDashboardStatusChange(value){
  state.dashboardFilters.status = value || 'all';
  applyDashboardFilters();
}

let dashboardQueryTimer = null;
function handleDashboardQuery(value){
  state.dashboardFilters.query = value || '';
  if (dashboardQueryTimer) clearTimeout(dashboardQueryTimer);
  dashboardQueryTimer = setTimeout(()=>{
    applyDashboardFilters();
  }, 220);
}

function applyDashboardFilters(){
  if (!state.currentUnit) return;
  const cache = state.lockerCache || {};
  if (cache.type === state.view && cache.unit === state.currentUnit.name && Array.isArray(cache.rows)) {
    renderLockerGrid(cache.rows, state.view, state.currentUnit.name);
  } else {
    renderLockers(state.view, state.currentUnit.name);
  }
}

function renderLockers(type, unit){
  google.script.run.withSuccessHandler(rows=>{
    if (!state.currentUnit || state.currentUnit.name !== unit) return;
    state.lockerCache = { type, unit, rows };
    renderLockerGrid(rows, type, unit);
  }).getLockersData(type, unit);
}

function renderLockerGrid(rows, type, unit){
  const grid = document.getElementById('grid');
  if (!grid) return;
  const allRows = Array.isArray(rows) ? rows : [];
  if (!allRows.length){
    grid.innerHTML = '<div class="empty-state">Nenhum arm√°rio configurado.</div>';
    state.notifications = [];
    updateNotificationBell();
    return;
  }
  const headers = allRows[0] || [];
  const idx = {
    number: headers.indexOf('Number'),
    status: headers.indexOf('Status'),
    visitor: headers.indexOf('Visitor Name'),
    phone: headers.indexOf('Phone'),
    patient: headers.indexOf('Patient Name'),
    bed: headers.indexOf('Bed'),
    start: headers.indexOf('Start Time'),
    items: headers.indexOf('Stored Items'),
    end: headers.indexOf('Expected End'),
  };
  if (idx.items === -1) idx.items = headers.indexOf('Welcome Sent');
  if (idx.end === -1) idx.end = headers.indexOf('End Time');
  const dataRows = allRows.slice(1).filter(row => {
    if (!row) return false;
    if (idx.number >= 0) {
      const value = row[idx.number];
      return value !== null && value !== undefined && String(value).trim() !== '';
    }
    return row.some(cell => cell !== null && cell !== undefined && String(cell).trim() !== '');
  });
  if (!dataRows.length){
    grid.innerHTML = '<div class="empty-state">Nenhum arm√°rio configurado.</div>';
    state.notifications = [];
    updateNotificationBell();
    return;
  }
  const statusFilter = (state.dashboardFilters.status || 'all').toLowerCase();
  const query = (state.dashboardFilters.query || '').toLowerCase();
  const notifications = [];
  grid.innerHTML = '';
  let appended = 0;
  dataRows.forEach(r=>{
    const number = idx.number >= 0 ? r[idx.number] : null;
    if (!number) return;
    const status = (idx.status >= 0 ? r[idx.status] : 'Free') || 'Free';
    const visitorName = idx.visitor >= 0 ? (r[idx.visitor] || '') : '';
    const patientName = idx.patient >= 0 ? (r[idx.patient] || '') : '';
    const phone = idx.phone >= 0 ? (r[idx.phone] || '') : '';
    const items = idx.items >= 0 ? (r[idx.items] || '') : '';
    const bed = idx.bed >= 0 ? (r[idx.bed] || '') : '';
    const end = idx.end >= 0 ? r[idx.end] : '';
    if (status === 'Overdue') {
      notifications.push({ locker:number, visitor:visitorName, patient:patientName, end });
    }
    if (statusFilter === 'free' && status !== 'Free') return;
    if (statusFilter === 'inuse' && status !== 'InUse') return;
    if (statusFilter === 'duesoon' && status !== 'DueSoon') return;
    if (statusFilter === 'overdue' && status !== 'Overdue') return;
    if (query) {
      const searchable = `${number} ${visitorName} ${patientName} ${phone} ${items} ${bed}`.toLowerCase();
      if (!searchable.includes(query)) return;
    }
    appended++;
    const div = document.createElement('div');
    div.className = `locker status-${status}`;
    const subtitle = status==='Free' ? 'Livre' : (status==='InUse' ? 'Em uso' : status==='DueSoon' ? 'A vencer' : 'Vencido');
    div.innerHTML = `${number}<small>${subtitle}</small>`;
    div.onclick = ()=>{
      if (status === 'Free') {
        openModal(getRegisterFormHTML(number, type));
      } else {
        const start = idx.start >= 0 ? r[idx.start] : '';
        openModal(getOccupancyHTML(number, visitorName, phone, patientName, bed, start, items, end, type));
      }
    };
    grid.appendChild(div);
  });
  if (!appended) {
    grid.innerHTML = '<div class="empty-state">Nenhum arm√°rio encontrado com os filtros selecionados.</div>';
  }
  state.notifications = notifications;
  updateNotificationBell();
}

function loadStats(type, unit){
  google.script.run.withSuccessHandler(s=>{
    if (!state.currentUnit || state.currentUnit.name !== unit) return;
    const setText = (id, value)=>{
      const el = document.getElementById(id);
      if (el) el.innerText = value;
    };
    setText('statFree', s.free);
    setText('statInUse', s.inUse);
    setText('statDueSoon', s.dueSoon);
    setText('statOverdue', s.overdue);
  }).getLockerStats(type, unit);
}

function updateNotificationBell(){
  const el = document.getElementById('notifCount');
  if (!el) return;
  const count = state.notifications.length;
  el.textContent = count;
  el.style.display = count ? 'grid' : 'none';
}

function showNotifications(){
  if (!state.notifications.length) {
    openModal('<h2>Notifica√ß√µes</h2><p>Tudo em dia! Nenhum arm√°rio vencido.</p>', 'notice');
    return;
  }
  const rows = state.notifications.map(n=>`<li><strong>${n.locker}</strong> - ${n.visitor||'Visitante'} (${n.patient||'Paciente'})<br><small>Vencido √†s ${formatDateTime(n.end)}</small></li>`).join('');
  openModal(`<h2>Arm√°rios vencidos</h2><ul style="padding-left:18px;display:flex;flex-direction:column;gap:10px;margin:0">${rows}</ul>`);
}

function formatDateTime(value){
  if (!value) return '-';
  try {
    const d = value instanceof Date ? value : new Date(value);
    if (isNaN(d.getTime())) return '-';
    return d.toLocaleString();
  } catch(e){ return '-'; }
}

function openModal(html, sound = 'modal'){
  if (sound) playSound(sound);
  document.getElementById('modalBody').innerHTML = html;
  document.getElementById('modal').classList.add('active');
}

function closeModal(){
  playSound('click');
  document.getElementById('modal').classList.remove('active');
  document.getElementById('modalBody').innerHTML = '';
}

function getRegisterFormHTML(lockerNum, type){
  const needsEnd = type === 'visitor';
  return `
    <h2>Registrar ‚Äì Arm√°rio ${lockerNum}</h2>
    <label>Nome do Visitante</label>
    <input id="r_visitor" />
    <label>Telefone</label>
    <input id="r_phone" />
    <label>Paciente</label>
    <input id="r_patient" />
    <label>Leito</label>
    <input id="r_bed" />
    <label>O que foi guardado?</label>
    <input id="r_items" placeholder="Ex: mochila, documentos" />
    ${needsEnd ? '<label>Previs√£o de retirada</label><input id="r_end" type="datetime-local" />' : ''}
    <button class="btn-primary" type="button" onclick="submitRegister('${lockerNum}','${type}')">Confirmar</button>
  `;
}

function submitRegister(lockerNum, type){
  const v = document.getElementById('r_visitor').value.trim();
  const p = document.getElementById('r_phone').value.trim();
  const pa = document.getElementById('r_patient').value.trim();
  const b = document.getElementById('r_bed').value.trim();
  const items = document.getElementById('r_items') ? document.getElementById('r_items').value.trim() : '';
  const end = document.getElementById('r_end') ? document.getElementById('r_end').value : '';
  if (!v || !p || !pa || !b) { playSound('error'); alert('Preencha todos os campos.'); return; }
  if (!items) { playSound('error'); alert('Descreva o que foi guardado.'); return; }
  if (type === 'visitor' && !end) { playSound('error'); alert('Informe a previs√£o de retirada.'); return; }
  const unit = state.currentUnit ? state.currentUnit.name : '';
  if (!unit) { playSound('error'); alert('Selecione uma unidade ativa antes de registrar.'); return; }

  google.script.run.withSuccessHandler(res=>{
    if (res && res.success) {
      playSound('success');
      closeModal();
      loadDashboard(state.view);
    } else {
      playSound('error');
      alert((res && res.message) || 'Falha ao registrar.');
    }
  }).registerVisitor(pa, b, v, p, items, end, type, unit, lockerNum);
}

function getOccupancyHTML(lockerNum, visitor, phone, patient, bed, start, items, end, type){
  const started = formatDateTime(start);
  const expected = formatDateTime(end);
  return `
    <h2>Arm√°rio ${lockerNum}</h2>
    <p><b>Visitante:</b> ${visitor || '-'}</p>
    <p><b>Telefone:</b> ${phone || '-'}</p>
    <p><b>Paciente:</b> ${patient || '-'}</p>
    <p><b>Leito:</b> ${bed || '-'}</p>
    <p><b>In√≠cio:</b> ${started}</p>
    <p><b>Conte√∫do:</b> ${items || '-'}</p>
    ${type==='visitor' ? `<p><b>Previs√£o de retirada:</b> ${expected}</p>` : ''}
    <div style="display:flex;gap:10px;flex-direction:column;margin-top:16px">
      <button class="btn-danger" type="button" onclick="confirmCheckout('${lockerNum}','${type}')">Dar baixa</button>
    </div>
  `;
}

function confirmCheckout(lockerNum, type){
  if (!confirm(`Confirmar baixa do arm√°rio ${lockerNum}?`)) return;
  playSound('click');
  const unit = state.currentUnit ? state.currentUnit.name : '';
  if (!unit) { playSound('error'); alert('Selecione uma unidade ativa.'); return; }
  google.script.run.withSuccessHandler(res=>{
    if (res && res.success) {
      playSound('success');
      closeModal();
      loadDashboard(state.view);
    } else {
      playSound('error');
      alert((res && res.message) || 'Falha ao concluir baixa.');
    }
  }).checkoutLocker(lockerNum, type, unit);
}

function showLockerSettings(){
  const content = document.getElementById('mainContent');
  if (!content) return;
  state.activePage = 'settings';
  const titleEl = document.getElementById('viewTitle');
  if (titleEl) titleEl.textContent = `Configura√ß√µes de Arm√°rios${state.currentUnit ? ' ¬∑ '+state.currentUnit.display : ''}`;
  if (!state.currentUnit) {
    content.innerHTML = '<div class="card"><h2>Configura√ß√£o</h2><p>Selecione uma unidade para configurar arm√°rios.</p></div>';
    return;
  }
  const unitName = state.currentUnit.name;
  content.innerHTML = `
    <div class="card">
      <div class="card-header"><h2>Configura√ß√£o de Arm√°rios ‚Äì ${state.currentUnit.display}</h2></div>
      <div class="config-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:20px;">
        <div class="card" style="margin:0;">
          <h3 style="margin-top:0">Visitantes</h3>
          <label>Total de arm√°rios</label><input id="cfgVisitorTotal" type="number" min="1" />
          <button class="btn-primary" type="button" onclick="saveLockerCfg('visitor')">Salvar</button>
          <p id="cfgVisitorHint" class="config-hint"></p>
        </div>
        <div class="card" style="margin:0;">
          <h3 style="margin-top:0">Acompanhantes</h3>
          <label>Total de arm√°rios</label><input id="cfgCompanionTotal" type="number" min="1" />
          <button class="btn-primary" type="button" onclick="saveLockerCfg('companion')">Salvar</button>
          <p id="cfgCompanionHint" class="config-hint"></p>
        </div>
      </div>
    </div>`;

  const updateHint = (type, cfg)=>{
    const totalInput = document.getElementById(type==='visitor' ? 'cfgVisitorTotal' : 'cfgCompanionTotal');
    const hint = document.getElementById(type==='visitor' ? 'cfgVisitorHint' : 'cfgCompanionHint');
    const total = Number(cfg && cfg.count) || Number(cfg.rows * cfg.cols) || 0;
    if (totalInput) totalInput.value = total;
    if (hint) hint.textContent = total ? `Distribui√ß√£o sugerida: ${cfg.rows} √ó ${cfg.cols} ¬∑ Total ${total}` : '';
  };

  google.script.run.withSuccessHandler(cfg=>updateHint('visitor', cfg)).getLockerConfig('visitor', unitName);
  google.script.run.withSuccessHandler(cfg=>updateHint('companion', cfg)).getLockerConfig('companion', unitName);
}

function saveLockerCfg(type){
  if (!state.currentUnit) return;
  const unit = state.currentUnit.name;
  const totalInput = document.getElementById(type==='visitor' ? 'cfgVisitorTotal' : 'cfgCompanionTotal');
  const total = Number(totalInput ? totalInput.value : 0);
  if (!total || total < 1) { playSound('error'); alert('Informe a quantidade total de arm√°rios.'); return; }
  playSound('click');
  google.script.run.withSuccessHandler(res=>{
    if (res && res.success) {
      playSound('success');
      const hint = document.getElementById(type==='visitor' ? 'cfgVisitorHint' : 'cfgCompanionHint');
      if (hint && res.layout) {
        hint.textContent = `Distribui√ß√£o sugerida: ${res.layout.rows} √ó ${res.layout.cols} ¬∑ Total ${res.count}`;
      }
      alert('Configura√ß√£o salva!');
      loadDashboard(state.view);
    } else {
      playSound('error');
      alert((res && res.message) || 'Falha ao salvar.');
    }
  }).setLockerConfig(type, total, unit);
}

function showUnitSettings(){
  const content = document.getElementById('mainContent');
  if (!content) return;
  state.activePage = 'units';
  const titleEl = document.getElementById('viewTitle');
  if (titleEl) titleEl.textContent = 'Administra√ß√£o ¬∑ Unidades';
  content.innerHTML = `
    <div class="card">
      <div class="card-header"><h2>Unidades</h2></div>
      <div class="card" style="margin:0 0 20px;">
        <h3 style="margin-top:0">Cadastrar unidade</h3>
        <label>Nome interno</label><input id="unit_name" placeholder="Ex: NAC" />
        <label>Nome exibido</label><input id="unit_display" placeholder="Ex: N√∫cleo de Atendimento" />
        <button class="btn-primary" type="button" onclick="addUnitUI()">Adicionar</button>
      </div>
      <div class="card" style="margin:0;">
        <h3 style="margin-top:0">Unidades ativas</h3>
        <div id="unitList">Carregando...</div>
      </div>
    </div>`;

  google.script.run.withSuccessHandler(units=>{
    const list = document.getElementById('unitList');
    if (!units.length){ list.innerHTML = '<i>Nenhuma unidade cadastrada.</i>'; return; }
    list.innerHTML = `<table><thead><tr><th>Nome</th><th>Exibi√ß√£o</th><th></th></tr></thead><tbody>${units.map(u=>`<tr><td>${u.name}</td><td>${u.display}</td><td style="text-align:right"><button class="btn-secondary" onclick="removeUnitUI('${u.name.replace(/'/g,"\\'")}')">Desativar</button></td></tr>`).join('')}</tbody></table>`;
  }).listUnits();
}

function addUnitUI(){
  const name = document.getElementById('unit_name').value.trim();
  const display = document.getElementById('unit_display').value.trim();
  playSound('click');
  if (!name){ playSound('error'); alert('Informe o nome da unidade.'); return; }
  google.script.run.withSuccessHandler(res=>{
    if (res && res.success){
      playSound('success');
      alert('Unidade salva!');
      loadUnitsAndStart(false, showUnitSettings);
    } else {
      playSound('error');
      alert((res && res.message) || 'Falha ao salvar unidade.');
    }
  }).addUnit(name, display);
}

function removeUnitUI(name){
  if (!confirm(`Desativar a unidade ${name}?`)) return;
  playSound('click');
  google.script.run.withSuccessHandler(res=>{
    if (res && res.success){
      playSound('success');
      alert('Unidade desativada.');
      loadUnitsAndStart(false, showUnitSettings);
    } else {
      playSound('error');
      alert((res && res.message) || 'Falha ao desativar.');
    }
  }).removeUnit(name);
}

function showUsers(){
  const content = document.getElementById('mainContent');
  if (!content) return;
  state.activePage = 'users';
  const titleEl = document.getElementById('viewTitle');
  if (titleEl) titleEl.textContent = 'Administra√ß√£o ¬∑ Usu√°rios';
  const unitOptions = (state.units || []).map(u=>`<label class="checkbox-pill"><input type="checkbox" value="${escapeHtml(u.name)}"><span>${escapeHtml(u.display)}</span></label>`).join('');
  content.innerHTML = `
    <div class="card">
      <div class="card-header"><h2>Usu√°rios</h2></div>
      <div class="card" style="margin:0 0 20px;">
        <h3 style="margin-top:0">Adicionar Usu√°rio</h3>
        <label>Usu√°rio</label><input id="u_username">
        <label>Senha</label><input id="u_password" type="password">
        <label>Email</label><input id="u_email" type="email">
        <label>Perfil</label>
        <select id="u_profile">
          <option value="admin">Admin</option>
          <option value="armario_visitante">Arm√°rio Visitante</option>
          <option value="guarda_volume">Guarda Volume</option>
        </select>
        <label>Unidades autorizadas</label>
        <div class="checkbox-grid" id="userUnitOptions">${unitOptions || '<span class="tag muted">Cadastre unidades para atribuir acessos.</span>'}</div>
        <small class="config-hint">Selecione todas as unidades que o usu√°rio poder√° monitorar.</small>
        <button class="btn-primary" type="button" onclick="addUserUI()">Adicionar</button>
      </div>
      <div class="card" style="margin:0;">
        <h3 style="margin-top:0">Usu√°rios cadastrados</h3>
        <div id="usersArea">Carregando...</div>
      </div>
    </div>`;

  google.script.run.withSuccessHandler(users=>{
    if (!Array.isArray(users) || !users.length) {
      document.getElementById('usersArea').innerHTML = '<div class="empty-state">Nenhum usu√°rio cadastrado.</div>';
      return;
    }
    const unitMap = new Map((state.units || []).map(u=>[u.name, u.display]));
    const rows = users.map(user=>{
      const units = Array.isArray(user.units) && user.units.length
        ? user.units.map(name=>`<span class="tag">${escapeHtml(unitMap.get(name) || name)}</span>`).join(' ')
        : '<span class="tag muted">Sem acesso</span>';
      const safeUser = escapeHtml(user.username);
      const encodedUnits = encodeURIComponent(JSON.stringify(user.units || []));
      return `<tr>
        <td>${safeUser}</td>
        <td>${escapeHtml(user.profile)}</td>
        <td>${escapeHtml(user.email || '')}</td>
        <td style="display:flex;flex-wrap:wrap;gap:6px;">${units}</td>
        <td style="text-align:right;display:flex;gap:8px;justify-content:flex-end;">
          <button class="btn-secondary" onclick="openUserUnitsModal('${user.username.replace(/'/g,"\\'")}', '${encodedUnits}')">Unidades</button>
          <button class="btn-secondary" onclick="resetPassUI('${user.username.replace(/'/g,"\\'")}')">Reset Senha</button>
          <button class="btn-danger" onclick="deleteUserUI('${user.username.replace(/'/g,"\\'")}')">Excluir</button>
        </td>
      </tr>`;
    }).join('');
    document.getElementById('usersArea').innerHTML = `<table><thead><tr><th>Usu√°rio</th><th>Perfil</th><th>Email</th><th>Unidades</th><th style="text-align:right">A√ß√µes</th></tr></thead><tbody>${rows}</tbody></table>`;
  }).listUsers();
}

function addUserUI(){
  const u=document.getElementById('u_username').value.trim();
  const p=document.getElementById('u_password').value;
  const e=document.getElementById('u_email').value.trim();
  const pr=document.getElementById('u_profile').value;
  const unitInputs = document.querySelectorAll('#userUnitOptions input[type="checkbox"]:checked');
  const units = Array.from(unitInputs).map(cb=>cb.value);
  playSound('click');
  if(!u||!p){ playSound('error'); alert('Usu√°rio e senha s√£o obrigat√≥rios.'); return; }
  if(pr !== PROFILES.ADMIN && !units.length){ playSound('error'); alert('Selecione pelo menos uma unidade para o usu√°rio.'); return; }
  google.script.run.withSuccessHandler(res=>{
    if(res && res.success){ playSound('success'); alert('Usu√°rio adicionado.'); showUsers(); }
    else { playSound('error'); alert((res && res.message) || 'Falha ao adicionar.'); }
  }).addUser(u,p,pr,e,units);
}

function resetPassUI(u){
  const np = prompt(`Nova senha para ${u}:`);
  if(!np) return;
  playSound('click');
  google.script.run.withSuccessHandler(res=>{
    if(res && res.success){ playSound('success'); alert('Senha atualizada.'); }
    else { playSound('error'); alert((res && res.message) || 'Falha ao atualizar senha.'); }
  }).resetPassword(u,np);
}

function deleteUserUI(u){
  if(!confirm(`Excluir usu√°rio ${u}?`)) return;
  playSound('click');
  google.script.run.withSuccessHandler(res=>{
    if(res && res.success){ playSound('success'); alert('Usu√°rio exclu√≠do.'); showUsers(); }
    else { playSound('error'); alert((res && res.message) || 'Falha ao excluir.'); }
  }).deleteUser(u);
}

function openUserUnitsModal(username, encodedUnits){
  let units = [];
  try {
    units = JSON.parse(decodeURIComponent(encodedUnits || '[]')) || [];
  } catch (err) {
    units = [];
  }
  const unitList = state.units || [];
  const options = unitList.length
    ? unitList.map(u=>`<label class="checkbox-pill"><input type="checkbox" value="${escapeHtml(u.name)}" ${units.includes(u.name)?'checked':''}><span>${escapeHtml(u.display)}</span></label>`).join('')
    : '<span class="tag muted">Cadastre unidades para conceder acesso.</span>';
  const body = `
    <h2>Unidades de ${escapeHtml(username)}</h2>
    <p>Selecione as unidades dispon√≠veis para o usu√°rio.</p>
    <div class="checkbox-grid" id="modalUserUnits">${options}</div>
    <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:18px;">
      <button class="btn-secondary" type="button" onclick="closeModal()">Cancelar</button>
      <button class="btn-primary" type="button" onclick="saveUserUnits('${username.replace(/'/g,"\\'")}')">Salvar</button>
    </div>`;
  openModal(body);
}

function saveUserUnits(username){
  playSound('click');
  const inputs = document.querySelectorAll('#modalUserUnits input[type="checkbox"]');
  const units = Array.from(inputs).filter(cb=>cb.checked).map(cb=>cb.value);
  google.script.run.withSuccessHandler(res=>{
    if (res && res.success) {
      playSound('success');
      closeModal();
      showUsers();
    } else {
      playSound('error');
      alert((res && res.message) || 'Falha ao atualizar unidades.');
    }
  }).updateUserUnits(username, units);
}

function showReports(){
  const content = document.getElementById('mainContent');
  if (!content) return;
  state.activePage = 'reports';
  const titleEl = document.getElementById('viewTitle');
  if (titleEl) titleEl.textContent = 'Relat√≥rios avan√ßados';
  const units = state.units || [];
  const selectedUnits = state.reportFilters.units || [];
  const unitChips = units.length
    ? units.map(u=>`<label class="checkbox-pill"><input type="checkbox" value="${escapeHtml(u.name)}" ${selectedUnits.includes(u.name)?'checked':''} onchange="toggleReportUnit(this.value,this.checked)"><span>${escapeHtml(u.display)}</span></label>`).join('')
    : '<span class="tag muted">Nenhuma unidade dispon√≠vel</span>';
  content.innerHTML = `
    <div class="card">
      <div class="card-header">
        <h2>Relat√≥rios avan√ßados</h2>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn-secondary" type="button" onclick="exportReportFile('csv')">Exportar CSV</button>
          <button class="btn-secondary" type="button" onclick="exportReportFile('pdf')">Exportar PDF</button>
        </div>
      </div>
      <div class="report-filters">
        <div class="control">
          <label>Tipo de registro</label>
          <select id="reportType" onchange="changeReportFilter('type', this.value)">
            <option value="all"${state.reportFilters.type==='all'?' selected':''}>Todos</option>
            <option value="visitor"${state.reportFilters.type==='visitor'?' selected':''}>Visitantes</option>
            <option value="companion"${state.reportFilters.type==='companion'?' selected':''}>Acompanhantes</option>
          </select>
        </div>
        <div class="control">
          <label>A√ß√£o</label>
          <select id="reportAction" onchange="changeReportFilter('action', this.value)">
            <option value="all"${state.reportFilters.action==='all'?' selected':''}>Todas</option>
            <option value="Registrar"${state.reportFilters.action==='Registrar'?' selected':''}>Entradas</option>
            <option value="Baixa"${state.reportFilters.action==='Baixa'?' selected':''}>Baixas</option>
          </select>
        </div>
        <div class="control">
          <label>Status operacional</label>
          <select id="reportStatus" onchange="changeReportFilter('status', this.value)">
            <option value="all"${state.reportFilters.status==='all'?' selected':''}>Todos</option>
            <option value="ativo"${state.reportFilters.status==='ativo'?' selected':''}>Ativos</option>
            <option value="concluido"${state.reportFilters.status==='concluido'?' selected':''}>Conclu√≠dos</option>
          </select>
        </div>
        <div class="control">
          <label>Data inicial</label>
          <input type="date" id="reportStart" value="${state.reportFilters.start || ''}" onchange="changeReportFilter('start', this.value)" />
        </div>
        <div class="control">
          <label>Data final</label>
          <input type="date" id="reportEnd" value="${state.reportFilters.end || ''}" onchange="changeReportFilter('end', this.value)" />
        </div>
        <div class="control" style="flex:1 1 240px;">
          <label>Busca</label>
          <input id="reportQuery" placeholder="Nome, paciente, arm√°rio ou item" value="${escapeHtml(state.reportFilters.query || '')}" oninput="handleReportQuery(this.value)" />
        </div>
      </div>
      <div class="card" style="margin:0 0 20px;">
        <h3 style="margin-top:0">Unidades inclu√≠das</h3>
        <div id="reportUnits" class="checkbox-grid">${unitChips}</div>
      </div>
      <div id="reportSummary" class="summary-grid"></div>
      <div class="card" style="margin:0;">
        <h3 style="margin-top:0">Registros filtrados</h3>
        <div id="reportTable">Carregando...</div>
      </div>
    </div>`;

  loadAdvancedReport();
}

function prepareReportFilters(){
  const filters = Object.assign({}, state.reportFilters);
  filters.units = (state.reportFilters.units || []).slice();
  if (!filters.units.length) {
    const fallback = (state.availableUnits && state.availableUnits.length ? state.availableUnits : state.units || []).map(u=>u.name);
    filters.units = fallback;
  }
  return filters;
}

function loadAdvancedReport(){
  const table = document.getElementById('reportTable');
  const summary = document.getElementById('reportSummary');
  if (table) table.innerHTML = '<div class="loading"><div class="loading-indicator"></div><span>Carregando registros...</span></div>';
  if (summary) summary.innerHTML = '';
  google.script.run.withSuccessHandler(res=>{
    if (!res || !res.success) {
      if (table) table.innerHTML = '<div class="empty-state">N√£o foi poss√≠vel carregar os registros.</div>';
      return;
    }
    renderReportSummary(res);
    renderReportTable(res);
  }).getAdvancedReport(prepareReportFilters());
}

function renderReportSummary(report){
  const summaryEl = document.getElementById('reportSummary');
  if (!summaryEl) return;
  const summary = report.summary || {};
  const total = summary.total || 0;
  const entries = summary.byAction ? (summary.byAction.Registrar || 0) : 0;
  const exits = summary.byAction ? (summary.byAction.Baixa || 0) : 0;
  const visitor = summary.byType ? (summary.byType.visitor || 0) : 0;
  const companion = summary.byType ? (summary.byType.companion || 0) : 0;
  const topUnit = summary.byUnit ? Object.keys(summary.byUnit).sort((a,b)=>summary.byUnit[b]-summary.byUnit[a])[0] : null;
  summaryEl.innerHTML = `
    <div class="summary-card"><span>Total de registros</span><strong>${total}</strong></div>
    <div class="summary-card"><span>Entradas registradas</span><strong>${entries}</strong><small style="color:var(--text-muted);font-size:0.8rem;">Baixas: ${exits}</small></div>
    <div class="summary-card"><span>Perfil</span><strong>${visitor}</strong><small style="color:var(--text-muted);font-size:0.8rem;">Acompanhantes: ${companion}</small></div>
    <div class="summary-card"><span>Unidade destaque</span><strong>${topUnit ? escapeHtml(topUnit) : '‚Äî'}</strong></div>`;
}

function renderReportTable(report){
  const table = document.getElementById('reportTable');
  if (!table) return;
  const rows = report.rows || [];
  if (!rows.length){
    table.innerHTML = '<div class="empty-state">Nenhum registro encontrado com os filtros aplicados.</div>';
    return;
  }
  const headers = report.headers || [];
  const head = headers.map(h=>`<th>${escapeHtml(h)}</th>`).join('');
  const body = rows.map(row=>{
    return `<tr>
      <td>${escapeHtml(row.timestampDisplay)}</td>
      <td>${escapeHtml(row.type)}</td>
      <td>${escapeHtml(row.unit)}</td>
      <td>${escapeHtml(row.visitorName)}</td>
      <td>${escapeHtml(row.patientName)}</td>
      <td>${escapeHtml(row.bed)}</td>
      <td>${escapeHtml(row.locker)}</td>
      <td>${escapeHtml(row.action)}</td>
      <td>${escapeHtml(row.storedItems)}</td>
      <td>${escapeHtml(row.expectedDisplay)}</td>
      <td>${escapeHtml(row.phone)}</td>
    </tr>`;
  }).join('');
  table.innerHTML = `<table><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table>`;
}

function changeReportFilter(key, value){
  state.reportFilters[key] = value || (key === 'status' ? 'all' : '');
  loadAdvancedReport();
}

let reportQueryTimer = null;
function handleReportQuery(value){
  state.reportFilters.query = value || '';
  if (reportQueryTimer) clearTimeout(reportQueryTimer);
  reportQueryTimer = setTimeout(()=>{
    loadAdvancedReport();
  }, 250);
}

function toggleReportUnit(unit, checked){
  const units = new Set(state.reportFilters.units || []);
  if (checked) units.add(unit);
  else units.delete(unit);
  state.reportFilters.units = Array.from(units);
  loadAdvancedReport();
}

function exportReportFile(format){
  playSound('click');
  google.script.run.withSuccessHandler(res=>{
    if (!res || !res.success){
      playSound('error');
      alert((res && res.message) || 'Falha ao exportar relat√≥rio.');
      return;
    }
    playSound('success');
    if (res.format === 'csv') {
      const blob = new Blob([res.data], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = res.filename || 'relatorio.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    } else if (res.format === 'pdf') {
      const link = document.createElement('a');
      link.href = 'data:application/pdf;base64,' + res.data;
      link.download = res.filename || 'relatorio.pdf';
      document.body.appendChild(link);
      link.click();
      link.remove();
    }
  }).exportAdvancedReport(format, prepareReportFilters());
}

function showIndicators(){
  const content = document.getElementById('mainContent');
  if (!content) return;
  state.view = 'indicators';
  state.activePage = 'indicators';
  updateNavigation();
  const titleEl = document.getElementById('viewTitle');
  if (titleEl) titleEl.textContent = 'Indicadores operacionais';
  const availableUnits = state.availableUnits.length ? state.availableUnits : state.units;
  if (!state.indicatorFilters.units || !state.indicatorFilters.units.length) {
    state.indicatorFilters.units = (availableUnits || []).map(u=>u.name);
  }
  const unitOptions = (availableUnits || []).map(u=>`<label class="checkbox-pill"><input type="checkbox" value="${escapeHtml(u.name)}" ${state.indicatorFilters.units.includes(u.name)?'checked':''} onchange="toggleIndicatorUnit(this.value,this.checked)"><span>${escapeHtml(u.display)}</span></label>`).join('');
  const type = state.indicatorFilters.type || 'all';
  const days = state.indicatorFilters.days || 30;
  content.innerHTML = `
    <div class="card">
      <div class="card-header"><h2>Indicadores estrat√©gicos</h2></div>
      <div class="dashboard-controls" style="margin-bottom:16px;">
        <div class="control">
          <label>Perfil analisado</label>
          <div class="toggle-group">
            <button class="toggle ${type==='all' ? 'active' : ''}" type="button" onclick="changeIndicatorFilter('type','all')">Todos</button>
            <button class="toggle ${type==='visitor' ? 'active' : ''}" type="button" onclick="changeIndicatorFilter('type','visitor')">Visitantes</button>
            <button class="toggle ${type==='companion' ? 'active' : ''}" type="button" onclick="changeIndicatorFilter('type','companion')">Acompanhantes</button>
          </div>
        </div>
        <div class="control">
          <label>Per√≠odo</label>
          <select id="indicatorDays" onchange="changeIndicatorFilter('days', this.value)">
            <option value="7"${Number(days)===7?' selected':''}>√öltimos 7 dias</option>
            <option value="15"${Number(days)===15?' selected':''}>√öltimos 15 dias</option>
            <option value="30"${Number(days)===30?' selected':''}>√öltimos 30 dias</option>
            <option value="60"${Number(days)===60?' selected':''}>√öltimos 60 dias</option>
          </select>
        </div>
      </div>
      <div class="card" style="margin:0 0 20px;">
        <h3 style="margin-top:0">Unidades analisadas</h3>
        <div id="indicatorUnits" class="checkbox-grid">${unitOptions || '<span class="tag muted">Cadastre unidades para visualizar indicadores.</span>'}</div>
      </div>
      <div class="indicator-grid" id="indicatorSummary"></div>
      <div class="card" style="margin:0 0 20px;">
        <h3 style="margin-top:0">Ocupa√ß√£o atual</h3>
        <div id="indicatorOccupancy">Carregando...</div>
      </div>
      <div class="card" style="margin:0 0 20px;">
        <h3 style="margin-top:0">Fluxo di√°rio</h3>
        <div id="indicatorActivity">Carregando...</div>
      </div>
      <div class="card" style="margin:0;">
        <h3 style="margin-top:0">Movimenta√ß√µes recentes</h3>
        <div id="indicatorRecent">Carregando...</div>
      </div>
    </div>`;

  loadIndicators();
}

function changeIndicatorFilter(key, value){
  if (key === 'days') {
    state.indicatorFilters.days = Number(value) || 30;
  } else {
    state.indicatorFilters[key] = value;
  }
  loadIndicators();
}

function toggleIndicatorUnit(unit, checked){
  const current = new Set(state.indicatorFilters.units || []);
  if (checked) current.add(unit);
  else current.delete(unit);
  state.indicatorFilters.units = Array.from(current);
  loadIndicators();
}

function loadIndicators(){
  const summary = document.getElementById('indicatorSummary');
  const occupancy = document.getElementById('indicatorOccupancy');
  const activity = document.getElementById('indicatorActivity');
  const recent = document.getElementById('indicatorRecent');
  if (summary) summary.innerHTML = '<div class="loading"><div class="loading-indicator"></div><span>Calculando indicadores...</span></div>';
  if (occupancy) occupancy.innerHTML = '';
  if (activity) activity.innerHTML = '';
  if (recent) recent.innerHTML = '';
  google.script.run.withSuccessHandler(renderIndicators).getIndicatorsData({
    type: state.indicatorFilters.type,
    units: state.indicatorFilters.units,
    days: state.indicatorFilters.days
  });
}

function renderIndicators(data){
  const summaryEl = document.getElementById('indicatorSummary');
  const occupancyEl = document.getElementById('indicatorOccupancy');
  const activityEl = document.getElementById('indicatorActivity');
  const recentEl = document.getElementById('indicatorRecent');
  if (!data || !data.success){
    if (summaryEl) summaryEl.innerHTML = '<div class="empty-state">N√£o foi poss√≠vel calcular os indicadores.</div>';
    if (occupancyEl) occupancyEl.innerHTML = '';
    if (activityEl) activityEl.innerHTML = '';
    if (recentEl) recentEl.innerHTML = '';
    return;
  }
  const totals = data.totals || { entries:0, checkouts:0 };
  const averageOccupancy = (data.occupancy || []).length
    ? (data.occupancy.reduce((sum, item)=>sum + (item.occupancyRate || 0), 0) / data.occupancy.length)
    : 0;
  const expected = data.expected || { averageHours:0, samples:0 };
  const period = data.period || {};
  if (summaryEl) {
    summaryEl.innerHTML = `
      <div class="indicator-card">
        <h3>Entradas no per√≠odo</h3>
        <strong>${totals.entries}</strong>
        <span class="tag muted">Per√≠odo: ${escapeHtml(formatDateTime(period.start))} ‚Üí ${escapeHtml(formatDateTime(period.end))}</span>
      </div>
      <div class="indicator-card">
        <h3>Baixas conclu√≠das</h3>
        <strong>${totals.checkouts}</strong>
        <span class="tag muted">Amostra de ${Number(period.days)||0} dias</span>
      </div>
      <div class="indicator-card">
        <h3>Taxa m√©dia de ocupa√ß√£o</h3>
        <strong>${(averageOccupancy*100).toFixed(1)}%</strong>
        <span class="tag muted">${data.occupancy && data.occupancy.length ? data.occupancy.length : 0} combina√ß√µes unidade/perfil</span>
      </div>
      <div class="indicator-card">
        <h3>Dura√ß√£o prevista m√©dia</h3>
        <strong>${expected.averageHours.toFixed(1)} h</strong>
        <span class="tag muted">${expected.samples || 0} registros com previs√£o</span>
      </div>`;
  }

  if (occupancyEl) {
    const occ = data.occupancy || [];
    if (!occ.length) {
      occupancyEl.innerHTML = '<div class="empty-state">Sem dados de ocupa√ß√£o para as unidades selecionadas.</div>';
    } else {
      const rows = occ.map(item=>`
        <tr>
          <td>${escapeHtml(item.unit)}</td>
          <td>${escapeHtml(item.type === 'visitor' ? 'Visitantes' : 'Acompanhantes')}</td>
          <td>${item.total}</td>
          <td>${item.inUse}</td>
          <td>${item.free}</td>
          <td>${item.overdue}</td>
          <td>${(item.occupancyRate*100).toFixed(1)}%</td>
        </tr>`).join('');
      occupancyEl.innerHTML = `<table><thead><tr><th>Unidade</th><th>Perfil</th><th>Total</th><th>Em uso</th><th>Livres</th><th>Vencidos</th><th>Ocupa√ß√£o</th></tr></thead><tbody>${rows}</tbody></table>`;
    }
  }

  if (activityEl) {
    const series = data.activity || [];
    if (!series.length) {
      activityEl.innerHTML = '<div class="empty-state">Sem movimenta√ß√µes no per√≠odo.</div>';
    } else {
      const rows = series.map(day=>`
        <tr>
          <td>${escapeHtml(day.date)}</td>
          <td>${day.entries}</td>
          <td>${day.checkouts}</td>
        </tr>`).join('');
      activityEl.innerHTML = `<table><thead><tr><th>Dia</th><th>Entradas</th><th>Baixas</th></tr></thead><tbody>${rows}</tbody></table>`;
    }
  }

  if (recentEl) {
    const recent = data.recent || [];
    if (!recent.length) {
      recentEl.innerHTML = '<div class="empty-state">Sem movimenta√ß√µes recentes.</div>';
    } else {
      const items = recent.map(item=>`
        <li><strong>${escapeHtml(item.timestampDisplay)}</strong> ¬∑ ${escapeHtml(item.action || '')} ¬∑ ${escapeHtml(item.type || '')} ¬∑ ${escapeHtml(item.unit || '')}<br><small>${escapeHtml(item.visitorName || 'Visitante')} ‚Üí ${escapeHtml(item.patientName || 'Paciente')} (${escapeHtml(item.locker || '-')})</small></li>`).join('');
      recentEl.innerHTML = `<ul style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:8px;">${items}</ul>`;
    }
  }
  playSound('insight');
}

function showAudit(){
  const content = document.getElementById('mainContent');
  if (!content) return;
  state.activePage = 'audit';
  const titleEl = document.getElementById('viewTitle');
  if (titleEl) titleEl.textContent = 'Auditoria e logs';
  content.innerHTML = `
    <div class="card">
      <div class="card-header"><h2>Auditoria do sistema</h2></div>
      <div class="card" style="margin:0 0 20px;">
        <h3 style="margin-top:0">Logs detalhados</h3>
        <div id="logsArea">Carregando...</div>
      </div>
      <div class="card" style="margin:0;">
        <h3 style="margin-top:0">Registros de auditoria</h3>
        <div id="auditArea">Carregando...</div>
      </div>
    </div>`;
  google.script.run.withSuccessHandler(renderAuditTable).getAuditLog();
  google.script.run.withSuccessHandler(renderLogsTable).getLogs(150);
}

function renderAuditTable(rows){
  const area = document.getElementById('auditArea');
  if (!area) return;
  if (!rows || rows.length <= 1){
    area.innerHTML = '<div class="empty-state">Nenhum evento de auditoria registrado.</div>';
    return;
  }
  const head = rows[0].map(h=>`<th>${escapeHtml(h)}</th>`).join('');
  const body = rows.slice(1).map(r=>`<tr>${r.map(v=>`<td>${escapeHtml(v instanceof Date ? formatDateTime(v) : (v||''))}</td>`).join('')}</tr>`).join('');
  area.innerHTML = `<table><thead><tr>${head}</tr></thead><tbody>${body}</tbody></table>`;
}

function renderLogsTable(logs){
  const area = document.getElementById('logsArea');
  if (!area) return;
  if (!Array.isArray(logs) || !logs.length){
    area.innerHTML = '<div class="empty-state">Nenhuma altera√ß√£o registrada at√© o momento.</div>';
    return;
  }
  const body = logs.slice().reverse().map(log=>{
    const ts = log.timestamp ? formatDateTime(log.timestamp) : '';
    const meta = describeMetadata(log.metadata || {});
    return `<tr>
      <td>${escapeHtml(ts)}</td>
      <td>${escapeHtml(log.user || '')}</td>
      <td>${escapeHtml(log.entity || '')}</td>
      <td>${escapeHtml(log.action || '')}</td>
      <td>${escapeHtml(log.details || '')}</td>
      <td>${meta}</td>
    </tr>`;
  }).join('');
  area.innerHTML = `<table><thead><tr><th>Data</th><th>Usu√°rio</th><th>Entidade</th><th>A√ß√£o</th><th>Detalhes</th><th>Meta</th></tr></thead><tbody>${body}</tbody></table>`;
}
</script>
</body>
</html>
